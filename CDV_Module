
/* ============================================================
   CDV Executive Summary / Table Query (SQL Server runnable)
   ============================================================ */

DECLARE @begFYWk  INT = 202601;  -- YYYYWW
DECLARE @endFYWk  INT = 202612;  -- YYYYWW

DECLARE @sqlWhere NVARCHAR(MAX) = N'1=1';

SELECT
    b.b_dois_ind,
    b.b_fin_nbr,
    b.b_level,
    b.b_fin_name,
    b.b_cluster_name,
    b.b_cluster,
    b.b_mpoo,
    b.b_fss_ind,
    b.b_dps_ind,
    b.b_rto_ind,

    /* Percent_to_Minimum_Standard_Target_90 -> percentage, 0 decimals */
    CAST(ROUND(
        100.0 *
        (
            CASE
                WHEN SUM(w.w_hrs_ldc21 + w.w_hrs_ldc29) = 0
                  OR SUM(w.w_vol_cas_ltr) = 0
                  OR SUM(w.w_vol_cas_flt) = 0
                THEN 0
                ELSE
                    (SUM(w.w_hrs_ldc21 + w.w_hrs_ldc29))
                    /
                    (
                        (
                            (
                                (CAST(SUM(w.w_vol_cas_ltr) AS DECIMAL(18,2)) / 18.0)
                              + (CAST(SUM(w.w_vol_cas_flt) AS DECIMAL(18,2)) /  8.0)
                              + (
                                    (CAST(SUM(w.w_vol_cas_ltr) AS DECIMAL(18,2))
                                   + CAST(SUM(w.w_vol_cas_flt) AS DECIMAL(18,2))) / 70.0
                                )
                            ) / 60.0
                        )
                        + (SUM(calc.cd_ern_fot))
                    )
            END
        )
    , 0) AS DECIMAL(9,0)) AS Percent_to_Minimum_Standard_Target_90,

    /* tot_pct_ach -> multiply by 100 (original x10 then "one more 10"), 2 decimals */
    CAST(ROUND(
        100.0 *
        (
            CASE
                WHEN SUM(
                    CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
                  + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2))
                ) = 0 THEN 0
                ELSE
                    (
                        SUM(CAST(calc.cd_ern_hrs_ldc21 AS DECIMAL(30,2)))
                      + SUM(CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,2)))
                      + SUM(CAST(calc.cd_ern_hrs_ldc23 AS DECIMAL(30,2)))
                      + SUM(CAST(calc.cd_ern_hrs_ldc26 AS DECIMAL(30,2)))
                      + SUM(CAST(calc.cd_ern_hrs_ldc27 AS DECIMAL(30,2)))
                      + SUM(CAST(calc.cd_ern_hrs_ldc29 AS DECIMAL(30,2)))
                    )
                    /
                    SUM(
                        CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
                      + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2))
                    )
            END
        )
    , 2) AS DECIMAL(18,2)) AS tot_pct_ach,

    /* dph_pct_2sply -> multiply by 100 (original x10 then "one more 10"), 2 decimals */
    CAST(ROUND(
        100.0 *
        (
            CASE
                WHEN SUM(w.w_sply_dels) = 0 OR SUM(w.w_sply_hrs) = 0
                  OR SUM(w.w_hrs_ldc21 + w.w_hrs_ldc22 + w.w_hrs_ldc23 + w.w_hrs_ldc24 + w.w_hrs_ldc26 + w.w_hrs_ldc27 + w.w_hrs_ldc28 + w.w_hrs_ldc29 + w.w_hrs_ldc92) = 0
                THEN 0
                ELSE
                    CASE
                        WHEN (CAST(SUM(w.w_sply_dels) AS DECIMAL(18,2)) / SUM(w.w_sply_hrs)) = 0
                          OR (CAST(SUM(w.w_cty_cupd) AS DECIMAL(18,2)) / SUM(w.w_hrs_ldc21 + w.w_hrs_ldc22 + w.w_hrs_ldc23 + w.w_hrs_ldc24 + w.w_hrs_ldc26 + w.w_hrs_ldc27 + w.w_hrs_ldc28 + w.w_hrs_ldc29 + w.w_hrs_ldc92)) = 0
                        THEN 0
                        ELSE
                            (
                                (CAST(SUM(w.w_cty_cupd) AS DECIMAL(18,2)) / SUM(w.w_hrs_ldc21 + w.w_hrs_ldc22 + w.w_hrs_ldc23 + w.w_hrs_ldc24 + w.w_hrs_ldc26 + w.w_hrs_ldc27 + w.w_hrs_ldc28 + w.w_hrs_ldc29 + w.w_hrs_ldc92))
                              - (CAST(SUM(w.w_sply_dels) AS DECIMAL(18,2)) / SUM(w.w_sply_hrs))
                            )
                            / (CAST(SUM(w.w_sply_dels) AS DECIMAL(18,2)) / SUM(w.w_sply_hrs))
                    END
            END
        )
    , 2) AS DECIMAL(18,2)) AS dph_pct_2sply,

    /* dps_letter_pct_target90 -> percentage, 0 decimals */
    CAST(ROUND(
        100.0 *
        (
            CASE WHEN SUM(w.w_vol_dps_ltr) = 0 THEN 0
                 ELSE (CAST(SUM(w.w_vol_dps_ltr) AS DECIMAL(18,2)) / SUM(w.w_vol_cas_ltr + w.w_vol_dps_ltr))
            END
        )
    , 0) AS DECIMAL(9,0)) AS dps_letter_pct_target90,

    /* dps_flat_pct -> percentage, 0 decimals */
    CAST(ROUND(
        100.0 *
        (
            CASE WHEN SUM(w.w_vol_dps_flt) = 0 THEN 0
                 ELSE (CAST(SUM(w.w_vol_dps_flt) AS DECIMAL(18,2)) / SUM(w.w_vol_cas_flt + w.w_vol_dps_flt))
            END
        )
    , 0) AS DECIMAL(9,0)) AS dps_flat_pct,

    /* Cased_volume_pct -> multiply by 10 (keep as requested), 0 decimals */
    CAST(ROUND(
        10.0 *
        (
            CASE WHEN SUM(w.w_vol_dps_ltr + w.w_vol_dps_flt + w.w_vol_cas_flt + w.w_vol_cas_ltr) = 0 THEN 0
                 ELSE SUM(w.w_vol_cas_flt + w.w_vol_cas_ltr)
                      / CAST(SUM(w.w_vol_dps_ltr + w.w_vol_dps_flt + w.w_vol_cas_flt + w.w_vol_cas_ltr) AS DECIMAL(18,2))
            END
        )
    , 0) AS DECIMAL(9,0)) AS Cased_volume_pct,

    /* overtime_pct -> multiply by 100, keep 2 decimals */
    CAST(ROUND(
        100.0 *
        (
            CASE WHEN SUM(w.w_hrs_car_ot) = 0 OR SUM(w.w_hrs_car_tot) = 0 THEN 0
                 ELSE (CAST(SUM(w.w_hrs_car_ot) AS DECIMAL(18,4)) / SUM(w.w_hrs_car_tot))
            END
        )
    , 2) AS DECIMAL(18,2)) AS overtime_pct,

    /* remaining: keep 2 decimals */
    CAST(ROUND(
        CASE
            WHEN SUM(calc.cd_ern_hrs_ldc21 + calc.cd_ern_hrs_ldc22 + calc.cd_ern_hrs_ldc26) = 0
              OR SUM(CAST(b.b_collection_unit_ind AS TINYINT)) = 1
            THEN 0
            ELSE
                (
                    ((b.b_hrs_ldc21 + b.b_hrs_ldc22 + b.b_hrs_ldc29 + CAST(b.b_car_rte_nbr AS DECIMAL(18,2)) * 4.0 / ann.ann_del_days) / 8.0)
                  - (((SUM(calc.cd_ern_hrs_ldc21 + calc.cd_ern_hrs_ldc22 + calc.cd_ern_hrs_ldc26) * prod.prod_fters_fact) / SUM(w.w_del_days)) / 8.0)
                )
        END
    , 2) AS DECIMAL(18,2)) AS CDPOM_opp_target,

    CAST(ROUND(
        CASE WHEN SUM(w.w_hrs_ldc21 + w.w_hrs_ldc26 + w.w_hrs_ldc29) = 0 THEN 0
             ELSE ((((SUM(w.w_hrs_ldc21 + w.w_hrs_ldc26 + w.w_hrs_ldc29)) - (SUM(calc.cd_ern_hrs_ldc21 + calc.cd_ern_hrs_ldc26))) / SUM(w.w_del_days)) / 8.0)
        END
    , 2) AS DECIMAL(18,2)) AS dly_ofc_opp,

    CAST(ROUND(
        CASE WHEN SUM(w.w_hrs_ldc22 + calc.cd_ern_hrs_ldc22) = 0 THEN 0
             ELSE (((SUM(w.w_hrs_ldc22) - SUM(calc.cd_ern_hrs_ldc22)) / SUM(w.w_del_days)) / 8.0)
        END
    , 2) AS DECIMAL(18,2)) AS dly_str_opp,

    CAST(ROUND(
        CASE WHEN SUM(w.w_hrs_ldc23 + w.w_hrs_ldc27 + calc.cd_ern_hrs_ldc23 + calc.cd_ern_hrs_ldc27) = 0 THEN 0
             ELSE (((SUM(w.w_hrs_ldc23 + w.w_hrs_ldc27) - ISNULL(SUM(calc.cd_ern_hrs_ldc23 + calc.cd_ern_hrs_ldc27),0)) / SUM(w.w_del_days)) / 8.0)
        END
    , 2) AS DECIMAL(18,2)) AS dly_oth_opp,

    CAST(ROUND(
        CASE WHEN SUM(w.w_hrs_ldc21 + w.w_hrs_ldc26 + w.w_hrs_ldc29 + w.w_hrs_ldc23 + w.w_hrs_ldc27) = 0 THEN 0
             ELSE
                ((((SUM(w.w_hrs_ldc21 + w.w_hrs_ldc26 + w.w_hrs_ldc29)) - (SUM(calc.cd_ern_hrs_ldc21 + calc.cd_ern_hrs_ldc26))) / SUM(w.w_del_days)) / 8.0)
              + (((SUM(w.w_hrs_ldc22) - SUM(calc.cd_ern_hrs_ldc22)) / SUM(w.w_del_days)) / 8.0)
              + (((SUM(w.w_hrs_ldc23 + w.w_hrs_ldc27) - ISNULL(SUM(calc.cd_ern_hrs_ldc23 + calc.cd_ern_hrs_ldc27),0)) / SUM(w.w_del_days)) / 8.0)
        END
    , 2) AS DECIMAL(18,2)) AS dly_tot_opp,

    CAST(ROUND((SUM(calc.cd_ern_f2b_hrs_tot) / SUM(w.w_del_days)) / 8.0, 2) AS DECIMAL(18,2)) AS cd_ern_routes,
    CAST(ROUND(SUM(w.w_cty_rte) / NULLIF(COUNT(w.w_wk), 0), 2) AS DECIMAL(18,2))              AS w_cty_rte,
    CAST(ROUND(ISNULL(tc.TotWebCoinsCarriers, 0), 2) AS DECIMAL(18,2))                          AS TotWebCoinsCarriers

FROM [PCDV_DW].dbo.var_base b WITH (NOLOCK)
JOIN [PCDV_DW].dbo.var_weekly w WITH (NOLOCK)
    ON b.b_fin_nbr = w.w_fin_nbr
JOIN [PCDV_DW].dbo.var_calc_cdv calc WITH (NOLOCK)
    ON b.b_fin_nbr = calc.calc_fin_nbr
   AND w.w_fy      = calc.calc_fy
   AND w.w_wk      = calc.calc_wk
JOIN [PCDV_DW].dbo.vw_TotalCarriers tc
    ON b.b_fin_nbr = tc.c_fin_nbr

JOIN [PCDV_Delpvar].dbo.avar_cdv_prod prod WITH (NOLOCK) ON 1 = 1
JOIN [PCDV_DW].dbo.var_annual ann WITH (NOLOCK)          ON 1 = 1

WHERE
    b.b_cdv_ind = 1
    AND b.b_level = 26
    AND b.b_mpoo <> 'X'
    AND ((calc.calc_fy * 100) + calc.calc_wk) BETWEEN @begFYWk AND @endFYWk

GROUP BY
    b.b_dois_ind,
    b.b_fin_nbr,
    b.b_level,
    b.b_fin_name,
    b.b_cluster,
    b.b_mpoo,
    b.b_hrs_fot_w_brk,
    prod.prod_fters_fact,
    b.b_sei_target,
    b.b_collection_unit_ind,
    b.b_cluster_name,
    b.b_car_rte_nbr,
    ann.ann_del_days,
    b.b_hrs_ldc21,
    b.b_hrs_ldc22,
    b.b_hrs_ldc29,
    b.b_sei_prev_yr,
    tc.TotWebCoinsCarriers,
    b.b_fss_ind,
    b.b_dps_ind,
    b.b_rto_ind

ORDER BY
    dly_tot_opp DESC;














/* ============================================================
   CDV Executive Summary / Table Query (SQL Server runnable)
   ============================================================ */

DECLARE @begFYWk  INT = 202601;  -- YYYYWW
DECLARE @endFYWk  INT = 202612;  -- YYYYWW

DECLARE @sqlWhere NVARCHAR(MAX) = N'1=1';

SELECT
    b.b_dois_ind,
    b.b_fin_nbr,
    b.b_level,
    b.b_fin_name,
    b.b_cluster_name,
    b.b_cluster,
    b.b_mpoo,
    b.b_fss_ind,
    b.b_dps_ind,
    b.b_rto_ind,

    /* Percent_to_Minimum_Standard_Target_90 -> percentage, 0 decimals */
    CAST(ROUND(
        100.0 *
        (
            CASE
                WHEN SUM(w.w_hrs_ldc21 + w.w_hrs_ldc29) = 0
                  OR SUM(w.w_vol_cas_ltr) = 0
                  OR SUM(w.w_vol_cas_flt) = 0
                THEN 0
                ELSE
                    (SUM(w.w_hrs_ldc21 + w.w_hrs_ldc29))
                    /
                    (
                        (
                            (
                                (CAST(SUM(w.w_vol_cas_ltr) AS DECIMAL(18,2)) / 18.0)
                              + (CAST(SUM(w.w_vol_cas_flt) AS DECIMAL(18,2)) /  8.0)
                              + (
                                    (CAST(SUM(w.w_vol_cas_ltr) AS DECIMAL(18,2))
                                   + CAST(SUM(w.w_vol_cas_flt) AS DECIMAL(18,2))) / 70.0
                                )
                            ) / 60.0
                        )
                        + (SUM(calc.cd_ern_fot))
                    )
            END
        )
    , 0) AS DECIMAL(9,0)) AS Percent_to_Minimum_Standard_Target_90,

    /* tot_pct_ach -> multiply by 10, 2 decimals */
    CAST(ROUND(
        10.0 *
        (
            CASE
                WHEN SUM(
                    CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
                  + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2))
                ) = 0 THEN 0
                ELSE
                    (
                        SUM(CAST(calc.cd_ern_hrs_ldc21 AS DECIMAL(30,2)))
                      + SUM(CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,2)))
                      + SUM(CAST(calc.cd_ern_hrs_ldc23 AS DECIMAL(30,2)))
                      + SUM(CAST(calc.cd_ern_hrs_ldc26 AS DECIMAL(30,2)))
                      + SUM(CAST(calc.cd_ern_hrs_ldc27 AS DECIMAL(30,2)))
                      + SUM(CAST(calc.cd_ern_hrs_ldc29 AS DECIMAL(30,2)))
                    )
                    /
                    SUM(
                        CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
                      + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2))
                    )
            END
        )
    , 2) AS DECIMAL(18,2)) AS tot_pct_ach,

    /* dph_pct_2sply -> multiply by 10, 2 decimals */
    CAST(ROUND(
        10.0 *
        (
            CASE
                WHEN SUM(w.w_sply_dels) = 0 OR SUM(w.w_sply_hrs) = 0
                  OR SUM(w.w_hrs_ldc21 + w.w_hrs_ldc22 + w.w_hrs_ldc23 + w.w_hrs_ldc24 + w.w_hrs_ldc26 + w.w_hrs_ldc27 + w.w_hrs_ldc28 + w.w_hrs_ldc29 + w.w_hrs_ldc92) = 0
                THEN 0
                ELSE
                    CASE
                        WHEN (CAST(SUM(w.w_sply_dels) AS DECIMAL(18,2)) / SUM(w.w_sply_hrs)) = 0
                          OR (CAST(SUM(w.w_cty_cupd) AS DECIMAL(18,2)) / SUM(w.w_hrs_ldc21 + w.w_hrs_ldc22 + w.w_hrs_ldc23 + w.w_hrs_ldc24 + w.w_hrs_ldc26 + w.w_hrs_ldc27 + w.w_hrs_ldc28 + w.w_hrs_ldc29 + w.w_hrs_ldc92)) = 0
                        THEN 0
                        ELSE
                            (
                                (CAST(SUM(w.w_cty_cupd) AS DECIMAL(18,2)) / SUM(w.w_hrs_ldc21 + w.w_hrs_ldc22 + w.w_hrs_ldc23 + w.w_hrs_ldc24 + w.w_hrs_ldc26 + w.w_hrs_ldc27 + w.w_hrs_ldc28 + w.w_hrs_ldc29 + w.w_hrs_ldc92))
                              - (CAST(SUM(w.w_sply_dels) AS DECIMAL(18,2)) / SUM(w.w_sply_hrs))
                            )
                            / (CAST(SUM(w.w_sply_dels) AS DECIMAL(18,2)) / SUM(w.w_sply_hrs))
                    END
            END
        )
    , 2) AS DECIMAL(18,2)) AS dph_pct_2sply,

    /* dps_letter_pct_target90 -> percentage, 0 decimals */
    CAST(ROUND(
        100.0 *
        (
            CASE WHEN SUM(w.w_vol_dps_ltr) = 0 THEN 0
                 ELSE (CAST(SUM(w.w_vol_dps_ltr) AS DECIMAL(18,2)) / SUM(w.w_vol_cas_ltr + w.w_vol_dps_ltr))
            END
        )
    , 0) AS DECIMAL(9,0)) AS dps_letter_pct_target90,

    /* dps_flat_pct -> percentage, 0 decimals */
    CAST(ROUND(
        100.0 *
        (
            CASE WHEN SUM(w.w_vol_dps_flt) = 0 THEN 0
                 ELSE (CAST(SUM(w.w_vol_dps_flt) AS DECIMAL(18,2)) / SUM(w.w_vol_cas_flt + w.w_vol_dps_flt))
            END
        )
    , 0) AS DECIMAL(9,0)) AS dps_flat_pct,

    /* Cased_volume_pct -> multiply by 10, 0 decimals */
    CAST(ROUND(
        10.0 *
        (
            CASE WHEN SUM(w.w_vol_dps_ltr + w.w_vol_dps_flt + w.w_vol_cas_flt + w.w_vol_cas_ltr) = 0 THEN 0
                 ELSE SUM(w.w_vol_cas_flt + w.w_vol_cas_ltr)
                      / CAST(SUM(w.w_vol_dps_ltr + w.w_vol_dps_flt + w.w_vol_cas_flt + w.w_vol_cas_ltr) AS DECIMAL(18,2))
            END
        )
    , 0) AS DECIMAL(9,0)) AS Cased_volume_pct,

    /* remaining: keep 2 decimals */
    CAST(ROUND(
        CASE WHEN SUM(w.w_hrs_car_ot) = 0 OR SUM(w.w_hrs_car_tot) = 0 THEN 0
             ELSE (CAST(SUM(w.w_hrs_car_ot) AS DECIMAL(18,4)) / SUM(w.w_hrs_car_tot))
        END
    , 2) AS DECIMAL(18,2)) AS overtime_pct,

    CAST(ROUND(
        CASE
            WHEN SUM(calc.cd_ern_hrs_ldc21 + calc.cd_ern_hrs_ldc22 + calc.cd_ern_hrs_ldc26) = 0
              OR SUM(CAST(b.b_collection_unit_ind AS TINYINT)) = 1
            THEN 0
            ELSE
                (
                    ((b.b_hrs_ldc21 + b.b_hrs_ldc22 + b.b_hrs_ldc29 + CAST(b.b_car_rte_nbr AS DECIMAL(18,2)) * 4.0 / ann.ann_del_days) / 8.0)
                  - (((SUM(calc.cd_ern_hrs_ldc21 + calc.cd_ern_hrs_ldc22 + calc.cd_ern_hrs_ldc26) * prod.prod_fters_fact) / SUM(w.w_del_days)) / 8.0)
                )
        END
    , 2) AS DECIMAL(18,2)) AS CDPOM_opp_target,

    CAST(ROUND(
        CASE WHEN SUM(w.w_hrs_ldc21 + w.w_hrs_ldc26 + w.w_hrs_ldc29) = 0 THEN 0
             ELSE ((((SUM(w.w_hrs_ldc21 + w.w_hrs_ldc26 + w.w_hrs_ldc29)) - (SUM(calc.cd_ern_hrs_ldc21 + calc.cd_ern_hrs_ldc26))) / SUM(w.w_del_days)) / 8.0)
        END
    , 2) AS DECIMAL(18,2)) AS dly_ofc_opp,

    CAST(ROUND(
        CASE WHEN SUM(w.w_hrs_ldc22 + calc.cd_ern_hrs_ldc22) = 0 THEN 0
             ELSE (((SUM(w.w_hrs_ldc22) - SUM(calc.cd_ern_hrs_ldc22)) / SUM(w.w_del_days)) / 8.0)
        END
    , 2) AS DECIMAL(18,2)) AS dly_str_opp,

    CAST(ROUND(
        CASE WHEN SUM(w.w_hrs_ldc23 + w.w_hrs_ldc27 + calc.cd_ern_hrs_ldc23 + calc.cd_ern_hrs_ldc27) = 0 THEN 0
             ELSE (((SUM(w.w_hrs_ldc23 + w.w_hrs_ldc27) - ISNULL(SUM(calc.cd_ern_hrs_ldc23 + calc.cd_ern_hrs_ldc27),0)) / SUM(w.w_del_days)) / 8.0)
        END
    , 2) AS DECIMAL(18,2)) AS dly_oth_opp,

    CAST(ROUND(
        CASE WHEN SUM(w.w_hrs_ldc21 + w.w_hrs_ldc26 + w.w_hrs_ldc29 + w.w_hrs_ldc23 + w.w_hrs_ldc27) = 0 THEN 0
             ELSE
                ((((SUM(w.w_hrs_ldc21 + w.w_hrs_ldc26 + w.w_hrs_ldc29)) - (SUM(calc.cd_ern_hrs_ldc21 + calc.cd_ern_hrs_ldc26))) / SUM(w.w_del_days)) / 8.0)
              + (((SUM(w.w_hrs_ldc22) - SUM(calc.cd_ern_hrs_ldc22)) / SUM(w.w_del_days)) / 8.0)
              + (((SUM(w.w_hrs_ldc23 + w.w_hrs_ldc27) - ISNULL(SUM(calc.cd_ern_hrs_ldc23 + calc.cd_ern_hrs_ldc27),0)) / SUM(w.w_del_days)) / 8.0)
        END
    , 2) AS DECIMAL(18,2)) AS dly_tot_opp,

    CAST(ROUND((SUM(calc.cd_ern_f2b_hrs_tot) / SUM(w.w_del_days)) / 8.0, 2) AS DECIMAL(18,2)) AS cd_ern_routes,
    CAST(ROUND(SUM(w.w_cty_rte) / NULLIF(COUNT(w.w_wk), 0), 2) AS DECIMAL(18,2))              AS w_cty_rte,
    CAST(ROUND(ISNULL(tc.TotWebCoinsCarriers, 0), 2) AS DECIMAL(18,2))                          AS TotWebCoinsCarriers

FROM [PCDV_DW].dbo.var_base b WITH (NOLOCK)
JOIN [PCDV_DW].dbo.var_weekly w WITH (NOLOCK)
    ON b.b_fin_nbr = w.w_fin_nbr
JOIN [PCDV_DW].dbo.var_calc_cdv calc WITH (NOLOCK)
    ON b.b_fin_nbr = calc.calc_fin_nbr
   AND w.w_fy      = calc.calc_fy
   AND w.w_wk      = calc.calc_wk
JOIN [PCDV_DW].dbo.vw_TotalCarriers tc
    ON b.b_fin_nbr = tc.c_fin_nbr

JOIN [PCDV_Delpvar].dbo.avar_cdv_prod prod WITH (NOLOCK) ON 1 = 1
JOIN [PCDV_DW].dbo.var_annual ann WITH (NOLOCK)          ON 1 = 1

WHERE
    b.b_cdv_ind = 1
    AND b.b_level = 26
    AND b.b_mpoo <> 'X'
    AND ((calc.calc_fy * 100) + calc.calc_wk) BETWEEN @begFYWk AND @endFYWk

GROUP BY
    b.b_dois_ind,
    b.b_fin_nbr,
    b.b_level,
    b.b_fin_name,
    b.b_cluster,
    b.b_mpoo,
    b.b_hrs_fot_w_brk,
    prod.prod_fters_fact,
    b.b_sei_target,
    b.b_collection_unit_ind,
    b.b_cluster_name,
    b.b_car_rte_nbr,
    ann.ann_del_days,
    b.b_hrs_ldc21,
    b.b_hrs_ldc22,
    b.b_hrs_ldc29,
    b.b_sei_prev_yr,
    tc.TotWebCoinsCarriers,
    b.b_fss_ind,
    b.b_dps_ind,
    b.b_rto_ind

ORDER BY
    dly_tot_opp DESC;












/* ============================================================
   CDV Executive Summary / Table Query (SQL Server runnable)
   - Replace @sqlWhere with your desired filter logic
   - Replace [PCDV_Delpvar] if your avar_cdv_prod lives elsewhere
   ============================================================ */

DECLARE @begFYWk  INT = 202601;  -- YYYYWW
DECLARE @endFYWk  INT = 202612;  -- YYYYWW

/* Example filter (replace this):
   unit:    b.b_lead_fin_nbr = '123456'
   cluster: b.b_cluster = 'A1'
   mpoo:    b.b_cluster = 'A1' AND b.b_mpoo = 'B2'
   area:    b.b_area = '4'
*/
DECLARE @sqlWhere NVARCHAR(MAX) = N'1=1';


SELECT
    b.b_dois_ind,
    b.b_fin_nbr,
    b.b_level,
    b.b_fin_name,
    b.b_cluster_name,
    b.b_cluster,
    b.b_mpoo,
    b.b_fss_ind,
    b.b_dps_ind,
    b.b_rto_ind,

    /* 2014-07-09; correctly uses earned FOT instead of actual */
    CASE
        WHEN SUM(w.w_hrs_ldc21 + w.w_hrs_ldc29) = 0
          OR SUM(w.w_vol_cas_ltr) = 0
          OR SUM(w.w_vol_cas_flt) = 0
        THEN 0
        ELSE
            (SUM(w.w_hrs_ldc21 + w.w_hrs_ldc29))
            /
            (
                (
                    (
                        (CAST(SUM(w.w_vol_cas_ltr) AS DECIMAL(18,2)) / 18.0)
                      + (CAST(SUM(w.w_vol_cas_flt) AS DECIMAL(18,2)) /  8.0)
                      + (
                            (CAST(SUM(w.w_vol_cas_ltr) AS DECIMAL(18,2))
                           + CAST(SUM(w.w_vol_cas_flt) AS DECIMAL(18,2))) / 70.0
                        )
                    ) / 60.0
                )
                + (SUM(calc.cd_ern_fot))
            )
    END AS Percent_to_Minimum_Standard_Target_90,

    CASE
        WHEN SUM(
            CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
          + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2))
        ) = 0 THEN 0
        ELSE
            (
                SUM(CAST(calc.cd_ern_hrs_ldc21 AS DECIMAL(30,2)))
              + SUM(CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,2)))
              + SUM(CAST(calc.cd_ern_hrs_ldc23 AS DECIMAL(30,2)))
              + SUM(CAST(calc.cd_ern_hrs_ldc26 AS DECIMAL(30,2)))
              + SUM(CAST(calc.cd_ern_hrs_ldc27 AS DECIMAL(30,2)))
              + SUM(CAST(calc.cd_ern_hrs_ldc29 AS DECIMAL(30,2)))
            )
            /
            SUM(
                CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
              + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2))
            )
    END AS tot_pct_ach,

    --CASE
    --    WHEN SUM(calc.cd_ern_hrs_ldc21) = 0 OR SUM(w.w_cty_cupd) = 0 OR SUM(w.w_hrs_ldc21 + w.w_hrs_ldc29) = 0
    --    THEN 0
    --    ELSE
    --        (CAST(SUM(w.w_cty_cupd) AS DECIMAL(18,2)) / SUM(w.w_hrs_ldc21 + w.w_hrs_ldc29))
    --      - (SUM(w.w_cty_cupd) / SUM(calc.cd_ern_hrs_ldc21))
    --END AS oei_var2earned,

    --CASE
    --    WHEN SUM(w.w_cty_cupd) = 0 OR SUM(w.w_hrs_ldc22) = 0 THEN 0
    --    ELSE (CAST(SUM(w.w_cty_cupd) AS DECIMAL(18,2)) / SUM(w.w_hrs_ldc22)) - (b.b_sei_target)
    --END AS sei_var2earned,

    CASE
        WHEN SUM(w.w_sply_dels) = 0 OR SUM(w.w_sply_hrs) = 0
          OR SUM(w.w_hrs_ldc21 + w.w_hrs_ldc22 + w.w_hrs_ldc23 + w.w_hrs_ldc24 + w.w_hrs_ldc26 + w.w_hrs_ldc27 + w.w_hrs_ldc28 + w.w_hrs_ldc29 + w.w_hrs_ldc92) = 0
        THEN 0
        ELSE
            CASE
                WHEN (CAST(SUM(w.w_sply_dels) AS DECIMAL(18,2)) / SUM(w.w_sply_hrs)) = 0
                  OR (CAST(SUM(w.w_cty_cupd) AS DECIMAL(18,2)) / SUM(w.w_hrs_ldc21 + w.w_hrs_ldc22 + w.w_hrs_ldc23 + w.w_hrs_ldc24 + w.w_hrs_ldc26 + w.w_hrs_ldc27 + w.w_hrs_ldc28 + w.w_hrs_ldc29 + w.w_hrs_ldc92)) = 0
                THEN 0
                ELSE
                    (
                        (CAST(SUM(w.w_cty_cupd) AS DECIMAL(18,2)) / SUM(w.w_hrs_ldc21 + w.w_hrs_ldc22 + w.w_hrs_ldc23 + w.w_hrs_ldc24 + w.w_hrs_ldc26 + w.w_hrs_ldc27 + w.w_hrs_ldc28 + w.w_hrs_ldc29 + w.w_hrs_ldc92))
                      - (CAST(SUM(w.w_sply_dels) AS DECIMAL(18,2)) / SUM(w.w_sply_hrs))
                    )
                    / (CAST(SUM(w.w_sply_dels) AS DECIMAL(18,2)) / SUM(w.w_sply_hrs))
            END
    END AS dph_pct_2sply,

    CASE WHEN SUM(w.w_vol_dps_ltr) = 0 THEN 0
         ELSE (CAST(SUM(w.w_vol_dps_ltr) AS DECIMAL(18,2)) / SUM(w.w_vol_cas_ltr + w.w_vol_dps_ltr))
    END AS dps_letter_pct_target90,

    CASE WHEN SUM(w.w_vol_dps_flt) = 0 THEN 0
         ELSE (CAST(SUM(w.w_vol_dps_flt) AS DECIMAL(18,2)) / SUM(w.w_vol_cas_flt + w.w_vol_dps_flt))
    END AS dps_flat_pct,

    CASE WHEN SUM(w.w_vol_dps_ltr + w.w_vol_dps_flt + w.w_vol_cas_flt + w.w_vol_cas_ltr) = 0 THEN 0
         ELSE SUM(w.w_vol_cas_flt + w.w_vol_cas_ltr)
              / CAST(SUM(w.w_vol_dps_ltr + w.w_vol_dps_flt + w.w_vol_cas_flt + w.w_vol_cas_ltr) AS DECIMAL(18,2))
    END AS Cased_volume_pct,

    CASE WHEN SUM(w.w_hrs_car_ot) = 0 OR SUM(w.w_hrs_car_tot) = 0 THEN 0
         ELSE (CAST(SUM(w.w_hrs_car_ot) AS DECIMAL(18,4)) / SUM(w.w_hrs_car_tot))
    END AS overtime_pct,

    CASE
        WHEN SUM(calc.cd_ern_hrs_ldc21 + calc.cd_ern_hrs_ldc22 + calc.cd_ern_hrs_ldc26) = 0
          OR SUM(CAST(b.b_collection_unit_ind AS TINYINT)) = 1
        THEN 0
        ELSE
            (
                ((b.b_hrs_ldc21 + b.b_hrs_ldc22 + b.b_hrs_ldc29 + CAST(b.b_car_rte_nbr AS DECIMAL(18,2)) * 4.0 / ann.ann_del_days) / 8.0)
              - (((SUM(calc.cd_ern_hrs_ldc21 + calc.cd_ern_hrs_ldc22 + calc.cd_ern_hrs_ldc26) * prod.prod_fters_fact) / SUM(w.w_del_days)) / 8.0)
            )
    END AS CDPOM_opp_target,

    CASE WHEN SUM(w.w_hrs_ldc21 + w.w_hrs_ldc26 + w.w_hrs_ldc29) = 0 THEN 0
         ELSE ((((SUM(w.w_hrs_ldc21 + w.w_hrs_ldc26 + w.w_hrs_ldc29)) - (SUM(calc.cd_ern_hrs_ldc21 + calc.cd_ern_hrs_ldc26))) / SUM(w.w_del_days)) / 8.0)
    END AS dly_ofc_opp,

    CASE WHEN SUM(w.w_hrs_ldc22 + calc.cd_ern_hrs_ldc22) = 0 THEN 0
         ELSE (((SUM(w.w_hrs_ldc22) - SUM(calc.cd_ern_hrs_ldc22)) / SUM(w.w_del_days)) / 8.0)
    END AS dly_str_opp,

    CASE WHEN SUM(w.w_hrs_ldc23 + w.w_hrs_ldc27 + calc.cd_ern_hrs_ldc23 + calc.cd_ern_hrs_ldc27) = 0 THEN 0
         ELSE (((SUM(w.w_hrs_ldc23 + w.w_hrs_ldc27) - ISNULL(SUM(calc.cd_ern_hrs_ldc23 + calc.cd_ern_hrs_ldc27),0)) / SUM(w.w_del_days)) / 8.0)
    END AS dly_oth_opp,

    /* Total daily opp (balanced parentheses) */
    CASE WHEN SUM(w.w_hrs_ldc21 + w.w_hrs_ldc26 + w.w_hrs_ldc29 + w.w_hrs_ldc23 + w.w_hrs_ldc27) = 0 THEN 0
         ELSE
            ((((SUM(w.w_hrs_ldc21 + w.w_hrs_ldc26 + w.w_hrs_ldc29)) - (SUM(calc.cd_ern_hrs_ldc21 + calc.cd_ern_hrs_ldc26))) / SUM(w.w_del_days)) / 8.0)
          + (((SUM(w.w_hrs_ldc22) - SUM(calc.cd_ern_hrs_ldc22)) / SUM(w.w_del_days)) / 8.0)
          + (((SUM(w.w_hrs_ldc23 + w.w_hrs_ldc27) - ISNULL(SUM(calc.cd_ern_hrs_ldc23 + calc.cd_ern_hrs_ldc27),0)) / SUM(w.w_del_days)) / 8.0)
    END AS dly_tot_opp,

    --CASE WHEN SUM(w.w_cty_cupd) = 0 OR SUM(w.w_hrs_ldc21 + w.w_hrs_ldc29) = 0 THEN 0
    --     ELSE CAST(SUM(w.w_cty_cupd) AS DECIMAL(18,2)) / SUM(w.w_hrs_ldc21 + w.w_hrs_ldc29)
    --END AS aoei,

    --CASE WHEN SUM(w.w_cty_cupd) = 0 OR SUM(w.w_hrs_ldc22) = 0 THEN 0
    --     ELSE (SUM(CAST(w.w_cty_cupd AS DECIMAL(18,4))) / SUM(w.w_hrs_ldc22))
    --END AS asei,

    --CASE
    --    WHEN SUM(w.w_sply_dels) = 0 OR SUM(w.w_hrs_ldc21sply + w.w_hrs_ldc29sply) = 0 OR SUM(w.w_hrs_ldc21 + w.w_hrs_ldc29) = 0
    --    THEN 0
    --    ELSE
    --        CASE
    --            WHEN (CAST(SUM(w.w_sply_dels) AS DECIMAL(30,2)) / SUM(w.w_hrs_ldc21sply + w.w_hrs_ldc29sply)) = 0
    --              OR (CAST(SUM(w.w_cty_cupd) AS DECIMAL(30,2)) / SUM(w.w_hrs_ldc21 + w.w_hrs_ldc29)) = 0
    --            THEN 0
    --            ELSE
    --                (
    --                    (CAST(SUM(w.w_cty_cupd) AS DECIMAL(30,2)) / SUM(w.w_hrs_ldc21 + w.w_hrs_ldc29))
    --                  - (CAST(SUM(w.w_sply_dels) AS DECIMAL(30,2)) / SUM(w.w_hrs_ldc21sply + w.w_hrs_ldc29sply))
    --                )
    --                / (CAST(SUM(w.w_sply_dels) AS DECIMAL(30,2)) / SUM(w.w_hrs_ldc21sply + w.w_hrs_ldc29sply))
    --        END
    --END AS oei2sply,

    --CASE
    --    WHEN SUM(w.w_sply_dels) = 0 OR SUM(w.w_hrs_ldc22sply) = 0 OR SUM(w.w_hrs_ldc22) = 0
    --    THEN 0
    --    ELSE
    --        CASE
    --            WHEN (CAST(SUM(w.w_sply_dels) AS DECIMAL(30,2)) / SUM(w.w_hrs_ldc22sply)) = 0
    --              OR (CAST(SUM(w.w_cty_cupd) AS DECIMAL(30,2)) / SUM(w.w_hrs_ldc22)) = 0
    --            THEN 0
    --            ELSE
    --                (
    --                    (CAST(SUM(w.w_cty_cupd) AS DECIMAL(30,2)) / SUM(w.w_hrs_ldc22))
    --                  - (CAST(SUM(w.w_sply_dels) AS DECIMAL(30,2)) / SUM(w.w_hrs_ldc22sply))
    --                )
    --                / (CAST(SUM(w.w_sply_dels) AS DECIMAL(30,2)) / SUM(w.w_hrs_ldc22sply))
    --        END
    --END AS sei2sply,

    (SUM(calc.cd_ern_f2b_hrs_tot) / SUM(w.w_del_days)) / 8.0 AS cd_ern_routes,
    SUM(w.w_cty_rte) / NULLIF(COUNT(w.w_wk), 0)              AS w_cty_rte,

    /* Change NULLs to zero */
    ISNULL(tc.TotWebCoinsCarriers, 0) AS TotWebCoinsCarriers

FROM [PCDV_DW].dbo.var_base b WITH (NOLOCK)
JOIN [PCDV_DW].dbo.var_weekly w WITH (NOLOCK)
    ON b.b_fin_nbr = w.w_fin_nbr
JOIN [PCDV_DW].dbo.var_calc_cdv calc WITH (NOLOCK)
    ON b.b_fin_nbr = calc.calc_fin_nbr
   AND w.w_fy      = calc.calc_fy
   AND w.w_wk      = calc.calc_wk
JOIN [PCDV_DW].dbo.vw_TotalCarriers tc
    ON b.b_fin_nbr = tc.c_fin_nbr

/* In CF this was a comma-join; use constant join here */
JOIN [PCDV_Delpvar].dbo.avar_cdv_prod prod WITH (NOLOCK) ON 1 = 1
JOIN [PCDV_DW].dbo.var_annual ann WITH (NOLOCK)                   ON 1 = 1

WHERE
    b.b_cdv_ind = 1
	AND b.b_level = 26
	--AND b.b_area = '4B'
	AND b.b_mpoo <> 'X'
    AND ((calc.calc_fy * 100) + calc.calc_wk) BETWEEN @begFYWk AND @endFYWk

GROUP BY
    b.b_dois_ind,
    b.b_fin_nbr,
    b.b_level,
    b.b_fin_name,
    b.b_cluster,
    b.b_mpoo,
    b.b_hrs_fot_w_brk,
    prod.prod_fters_fact,
    b.b_sei_target,
    b.b_collection_unit_ind,
    b.b_cluster_name,
    b.b_car_rte_nbr,
    ann.ann_del_days,
    b.b_hrs_ldc21,
    b.b_hrs_ldc22,
    b.b_hrs_ldc29,
    b.b_sei_prev_yr,
    tc.TotWebCoinsCarriers,
    b.b_fss_ind,
    b.b_dps_ind,
    b.b_rto_ind

ORDER BY
    dly_tot_opp DESC;










/* ============================================================
   CDV Executive Summary / Table Query (SQL Server runnable)
   - Replace @sqlWhere with your desired filter logic
   - Replace [PCDV_Delpvar] if your avar_cdv_prod lives elsewhere
   ============================================================ */

DECLARE @begFYWk  INT = 202501;  -- YYYYWW
DECLARE @endFYWk  INT = 202552;  -- YYYYWW

/* Example filter (replace this):
   unit:    b.b_lead_fin_nbr = '123456'
   cluster: b.b_cluster = 'A1'
   mpoo:    b.b_cluster = 'A1' AND b.b_mpoo = 'B2'
   area:    b.b_area = '4'
*/
DECLARE @sqlWhere NVARCHAR(MAX) = N'1=1';

DECLARE @sql NVARCHAR(MAX) = N'
SELECT
    b.b_dois_ind,
    b.b_fin_nbr,
    b.b_level,
    b.b_fin_name,
    b.b_cluster_name,
    b.b_cluster,
    b.b_mpoo,
    b.b_fss_ind,
    b.b_dps_ind,
    b.b_rto_ind,

    /* 2014-07-09; correctly uses earned FOT instead of actual */
    CASE
        WHEN SUM(w.w_hrs_ldc21 + w.w_hrs_ldc29) = 0
          OR SUM(w.w_vol_cas_ltr) = 0
          OR SUM(w.w_vol_cas_flt) = 0
        THEN 0
        ELSE
            (SUM(w.w_hrs_ldc21 + w.w_hrs_ldc29))
            /
            (
                (
                    (
                        (CAST(SUM(w.w_vol_cas_ltr) AS DECIMAL(18,2)) / 18.0)
                      + (CAST(SUM(w.w_vol_cas_flt) AS DECIMAL(18,2)) /  8.0)
                      + (
                            (CAST(SUM(w.w_vol_cas_ltr) AS DECIMAL(18,2))
                           + CAST(SUM(w.w_vol_cas_flt) AS DECIMAL(18,2))) / 70.0
                        )
                    ) / 60.0
                )
                + (SUM(calc.cd_ern_fot))
            )
    END AS act_pct_standard,

    CASE
        WHEN SUM(
            CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
          + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2))
        ) = 0 THEN 0
        ELSE
            (
                SUM(CAST(calc.cd_ern_hrs_ldc21 AS DECIMAL(30,2)))
              + SUM(CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,2)))
              + SUM(CAST(calc.cd_ern_hrs_ldc23 AS DECIMAL(30,2)))
              + SUM(CAST(calc.cd_ern_hrs_ldc26 AS DECIMAL(30,2)))
              + SUM(CAST(calc.cd_ern_hrs_ldc27 AS DECIMAL(30,2)))
              + SUM(CAST(calc.cd_ern_hrs_ldc29 AS DECIMAL(30,2)))
            )
            /
            SUM(
                CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
              + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2))
            )
    END AS tot_pct_ach,

    CASE
        WHEN SUM(calc.cd_ern_hrs_ldc21) = 0 OR SUM(w.w_cty_cupd) = 0 OR SUM(w.w_hrs_ldc21 + w.w_hrs_ldc29) = 0
        THEN 0
        ELSE
            (CAST(SUM(w.w_cty_cupd) AS DECIMAL(18,2)) / SUM(w.w_hrs_ldc21 + w.w_hrs_ldc29))
          - (SUM(w.w_cty_cupd) / SUM(calc.cd_ern_hrs_ldc21))
    END AS oei_var2earned,

    CASE
        WHEN SUM(w.w_cty_cupd) = 0 OR SUM(w.w_hrs_ldc22) = 0 THEN 0
        ELSE (CAST(SUM(w.w_cty_cupd) AS DECIMAL(18,2)) / SUM(w.w_hrs_ldc22)) - (b.b_sei_target)
    END AS sei_var2earned,

    CASE
        WHEN SUM(w.w_sply_dels) = 0 OR SUM(w.w_sply_hrs) = 0
          OR SUM(w.w_hrs_ldc21 + w.w_hrs_ldc22 + w.w_hrs_ldc23 + w.w_hrs_ldc24 + w.w_hrs_ldc26 + w.w_hrs_ldc27 + w.w_hrs_ldc28 + w.w_hrs_ldc29 + w.w_hrs_ldc92) = 0
        THEN 0
        ELSE
            CASE
                WHEN (CAST(SUM(w.w_sply_dels) AS DECIMAL(18,2)) / SUM(w.w_sply_hrs)) = 0
                  OR (CAST(SUM(w.w_cty_cupd) AS DECIMAL(18,2)) / SUM(w.w_hrs_ldc21 + w.w_hrs_ldc22 + w.w_hrs_ldc23 + w.w_hrs_ldc24 + w.w_hrs_ldc26 + w.w_hrs_ldc27 + w.w_hrs_ldc28 + w.w_hrs_ldc29 + w.w_hrs_ldc92)) = 0
                THEN 0
                ELSE
                    (
                        (CAST(SUM(w.w_cty_cupd) AS DECIMAL(18,2)) / SUM(w.w_hrs_ldc21 + w.w_hrs_ldc22 + w.w_hrs_ldc23 + w.w_hrs_ldc24 + w.w_hrs_ldc26 + w.w_hrs_ldc27 + w.w_hrs_ldc28 + w.w_hrs_ldc29 + w.w_hrs_ldc92))
                      - (CAST(SUM(w.w_sply_dels) AS DECIMAL(18,2)) / SUM(w.w_sply_hrs))
                    )
                    / (CAST(SUM(w.w_sply_dels) AS DECIMAL(18,2)) / SUM(w.w_sply_hrs))
            END
    END AS dph2sply,

    CASE WHEN SUM(w.w_vol_dps_ltr) = 0 THEN 0
         ELSE (CAST(SUM(w.w_vol_dps_ltr) AS DECIMAL(18,2)) / SUM(w.w_vol_cas_ltr + w.w_vol_dps_ltr))
    END AS dps_pct,

    CASE WHEN SUM(w.w_vol_dps_flt) = 0 THEN 0
         ELSE (CAST(SUM(w.w_vol_dps_flt) AS DECIMAL(18,2)) / SUM(w.w_vol_cas_flt + w.w_vol_dps_flt))
    END AS fss_pct,

    CASE WHEN SUM(w.w_vol_dps_ltr + w.w_vol_dps_flt + w.w_vol_cas_flt + w.w_vol_cas_ltr) = 0 THEN 0
         ELSE SUM(w.w_vol_cas_flt + w.w_vol_cas_ltr)
              / CAST(SUM(w.w_vol_dps_ltr + w.w_vol_dps_flt + w.w_vol_cas_flt + w.w_vol_cas_ltr) AS DECIMAL(18,2))
    END AS ManVolPct,

    CASE WHEN SUM(w.w_hrs_car_ot) = 0 OR SUM(w.w_hrs_car_tot) = 0 THEN 0
         ELSE (CAST(SUM(w.w_hrs_car_ot) AS DECIMAL(18,4)) / SUM(w.w_hrs_car_tot))
    END AS ot_pct,

    CASE
        WHEN SUM(calc.cd_ern_hrs_ldc21 + calc.cd_ern_hrs_ldc22 + calc.cd_ern_hrs_ldc26) = 0
          OR SUM(CAST(b.b_collection_unit_ind AS TINYINT)) = 1
        THEN 0
        ELSE
            (
                ((b.b_hrs_ldc21 + b.b_hrs_ldc22 + b.b_hrs_ldc29 + CAST(b.b_car_rte_nbr AS DECIMAL(18,2)) * 4.0 / ann.ann_del_days) / 8.0)
              - (((SUM(calc.cd_ern_hrs_ldc21 + calc.cd_ern_hrs_ldc22 + calc.cd_ern_hrs_ldc26) * prod.prod_fters_fact) / SUM(w.w_del_days)) / 8.0)
            )
    END AS dly_fters_opp,

    CASE WHEN SUM(w.w_hrs_ldc21 + w.w_hrs_ldc26 + w.w_hrs_ldc29) = 0 THEN 0
         ELSE ((((SUM(w.w_hrs_ldc21 + w.w_hrs_ldc26 + w.w_hrs_ldc29)) - (SUM(calc.cd_ern_hrs_ldc21 + calc.cd_ern_hrs_ldc26))) / SUM(w.w_del_days)) / 8.0)
    END AS dly_ofc_opp,

    CASE WHEN SUM(w.w_hrs_ldc22 + calc.cd_ern_hrs_ldc22) = 0 THEN 0
         ELSE (((SUM(w.w_hrs_ldc22) - SUM(calc.cd_ern_hrs_ldc22)) / SUM(w.w_del_days)) / 8.0)
    END AS dly_str_opp,

    CASE WHEN SUM(w.w_hrs_ldc23 + w.w_hrs_ldc27 + calc.cd_ern_hrs_ldc23 + calc.cd_ern_hrs_ldc27) = 0 THEN 0
         ELSE (((SUM(w.w_hrs_ldc23 + w.w_hrs_ldc27) - ISNULL(SUM(calc.cd_ern_hrs_ldc23 + calc.cd_ern_hrs_ldc27),0)) / SUM(w.w_del_days)) / 8.0)
    END AS dly_oth_opp,

    /* Total daily opp (balanced parentheses) */
    CASE WHEN SUM(w.w_hrs_ldc21 + w.w_hrs_ldc26 + w.w_hrs_ldc29 + w.w_hrs_ldc23 + w.w_hrs_ldc27) = 0 THEN 0
         ELSE
            ((((SUM(w.w_hrs_ldc21 + w.w_hrs_ldc26 + w.w_hrs_ldc29)) - (SUM(calc.cd_ern_hrs_ldc21 + calc.cd_ern_hrs_ldc26))) / SUM(w.w_del_days)) / 8.0)
          + (((SUM(w.w_hrs_ldc22) - SUM(calc.cd_ern_hrs_ldc22)) / SUM(w.w_del_days)) / 8.0)
          + (((SUM(w.w_hrs_ldc23 + w.w_hrs_ldc27) - ISNULL(SUM(calc.cd_ern_hrs_ldc23 + calc.cd_ern_hrs_ldc27),0)) / SUM(w.w_del_days)) / 8.0)
    END AS dly_tot_opp,

    CASE WHEN SUM(w.w_cty_cupd) = 0 OR SUM(w.w_hrs_ldc21 + w.w_hrs_ldc29) = 0 THEN 0
         ELSE CAST(SUM(w.w_cty_cupd) AS DECIMAL(18,2)) / SUM(w.w_hrs_ldc21 + w.w_hrs_ldc29)
    END AS aoei,

    CASE WHEN SUM(w.w_cty_cupd) = 0 OR SUM(w.w_hrs_ldc22) = 0 THEN 0
         ELSE (SUM(CAST(w.w_cty_cupd AS DECIMAL(18,4))) / SUM(w.w_hrs_ldc22))
    END AS asei,

    CASE
        WHEN SUM(w.w_sply_dels) = 0 OR SUM(w.w_hrs_ldc21sply + w.w_hrs_ldc29sply) = 0 OR SUM(w.w_hrs_ldc21 + w.w_hrs_ldc29) = 0
        THEN 0
        ELSE
            CASE
                WHEN (CAST(SUM(w.w_sply_dels) AS DECIMAL(30,2)) / SUM(w.w_hrs_ldc21sply + w.w_hrs_ldc29sply)) = 0
                  OR (CAST(SUM(w.w_cty_cupd) AS DECIMAL(30,2)) / SUM(w.w_hrs_ldc21 + w.w_hrs_ldc29)) = 0
                THEN 0
                ELSE
                    (
                        (CAST(SUM(w.w_cty_cupd) AS DECIMAL(30,2)) / SUM(w.w_hrs_ldc21 + w.w_hrs_ldc29))
                      - (CAST(SUM(w.w_sply_dels) AS DECIMAL(30,2)) / SUM(w.w_hrs_ldc21sply + w.w_hrs_ldc29sply))
                    )
                    / (CAST(SUM(w.w_sply_dels) AS DECIMAL(30,2)) / SUM(w.w_hrs_ldc21sply + w.w_hrs_ldc29sply))
            END
    END AS oei2sply,

    CASE
        WHEN SUM(w.w_sply_dels) = 0 OR SUM(w.w_hrs_ldc22sply) = 0 OR SUM(w.w_hrs_ldc22) = 0
        THEN 0
        ELSE
            CASE
                WHEN (CAST(SUM(w.w_sply_dels) AS DECIMAL(30,2)) / SUM(w.w_hrs_ldc22sply)) = 0
                  OR (CAST(SUM(w.w_cty_cupd) AS DECIMAL(30,2)) / SUM(w.w_hrs_ldc22)) = 0
                THEN 0
                ELSE
                    (
                        (CAST(SUM(w.w_cty_cupd) AS DECIMAL(30,2)) / SUM(w.w_hrs_ldc22))
                      - (CAST(SUM(w.w_sply_dels) AS DECIMAL(30,2)) / SUM(w.w_hrs_ldc22sply))
                    )
                    / (CAST(SUM(w.w_sply_dels) AS DECIMAL(30,2)) / SUM(w.w_hrs_ldc22sply))
            END
    END AS sei2sply,

    (SUM(calc.cd_ern_f2b_hrs_tot) / SUM(w.w_del_days)) / 8.0 AS cd_ern_routes,
    SUM(w.w_cty_rte) / NULLIF(COUNT(w.w_wk), 0)              AS w_cty_rte,

    /* Change NULLs to zero */
    ISNULL(tc.TotWebCoinsCarriers, 0) AS TotWebCoinsCarriers

FROM dbo.var_base b WITH (NOLOCK)
JOIN dbo.var_weekly w WITH (NOLOCK)
    ON b.b_fin_nbr = w.w_fin_nbr
JOIN dbo.var_calc_cdv calc WITH (NOLOCK)
    ON b.b_fin_nbr = calc.calc_fin_nbr
   AND w.w_fy      = calc.calc_fy
   AND w.w_wk      = calc.calc_wk
JOIN dbo.vw_TotalCarriers tc
    ON b.b_fin_nbr = tc.c_fin_nbr

/* In CF this was a comma-join; use constant join here */
JOIN [PCDV_Delpvar].dbo.avar_cdv_prod prod WITH (NOLOCK) ON 1 = 1
JOIN dbo.var_annual ann WITH (NOLOCK)                   ON 1 = 1

WHERE
    b.b_cdv_ind = 1
    AND b.b_mpoo <> ''X''
    AND (' + @sqlWhere + N')
    AND ((calc.calc_fy * 100) + calc.calc_wk) BETWEEN @begFYWk AND @endFYWk

GROUP BY
    b.b_dois_ind,
    b.b_fin_nbr,
    b.b_level,
    b.b_fin_name,
    b.b_cluster,
    b.b_mpoo,
    b.b_hrs_fot_w_brk,
    prod.prod_fters_fact,
    b.b_sei_target,
    b.b_collection_unit_ind,
    b.b_cluster_name,
    b.b_car_rte_nbr,
    ann.ann_del_days,
    b.b_hrs_ldc21,
    b.b_hrs_ldc22,
    b.b_hrs_ldc29,
    b.b_sei_prev_yr,
    tc.TotWebCoinsCarriers,
    b.b_fss_ind,
    b.b_dps_ind,
    b.b_rto_ind

ORDER BY
    dly_tot_opp DESC;
';

EXEC sys.sp_executesql
    @sql,
    N'@begFYWk INT, @endFYWk INT',
    @begFYWk = @begFYWk,
    @endFYWk = @endFYWk;

















SELECT b_dois_ind, b_fin_nbr, b_level, b_fin_name, b_cluster_name, b_cluster, b_mpoo, b_fss_ind, b_dps_ind, b_rto_ind,

                <!--- Incorrect column for pct to standard
                CASE WHEN SUM(w_hrs_ldc21+w_hrs_ldc29)=0 OR SUM(w_vol_cas_ltr)=0 OR SUM(w_vol_cas_flt)=0
                THEN 0 ELSE
                (SUM(w_hrs_ldc21+w_hrs_ldc29))/
                (((((CAST(SUM(w_vol_cas_ltr) AS DECIMAL(18,2))/18)+(CAST(SUM(w_vol_cas_flt) AS DECIMAL(18,2))/8)+
                ((CAST(SUM(w_vol_cas_ltr) AS DECIMAL(18,2))+CAST(SUM(w_vol_cas_flt) AS DECIMAL(18,2)))/70))/60))
                +((b_hrs_fot_w_brk)*sum(w_del_days)))
                END act_pct_standard,
                --->

                <!--- 2014-07-09; fixed to correctly use earned fot (fixed office time) instead of actual --->
                CASE WHEN SUM(w_hrs_ldc21+w_hrs_ldc29) = 0 OR SUM(w_vol_cas_ltr) = 0 OR SUM(w_vol_cas_flt) = 0 THEN 0
                    ELSE (SUM(w_hrs_ldc21+w_hrs_ldc29))/
                        (((((CAST(SUM(w_vol_cas_ltr) AS DECIMAL(18,2))/18)+(CAST(SUM(w_vol_cas_FLT) AS DECIMAL(18,2))/8) +
                        ((CAST(SUM(w_vol_cas_ltr) AS DECIMAL(18,2))+CAST(SUM(w_vol_cas_FLT) AS DECIMAL(18,2)))/70))/60)) +
                        ((SUM(cd_ern_fot))))
                END act_pct_standard,

                CASE WHEN SUM(CAST(w_hrs_ldc21 as decimal(30,2))+ CAST(w_hrs_ldc22 as decimal(30,2))+ CAST(w_hrs_ldc23 as decimal(30,2)) + CAST(w_hrs_ldc26 as decimal(30,2))+ CAST(w_hrs_ldc27 as decimal(30,2)) + CAST(w_hrs_ldc29 as decimal(30,2)))=0 THEN 0
                    ELSE (SUM(CAST(cd_ern_hrs_ldc21 AS DECIMAL(30,2))) +SUM(CAST(cd_ern_hrs_ldc22 AS DECIMAL(30,2))) +SUM(CAST(cd_ern_hrs_ldc23 AS DECIMAL(30,2))) +SUM(CAST(cd_ern_hrs_ldc26 AS DECIMAL(30,2))) +SUM(CAST(cd_ern_hrs_ldc27 AS DECIMAL(30,2))) +SUM(CAST(cd_ern_hrs_ldc29 AS DECIMAL(30,2))))/
                            SUM(CAST(w_hrs_ldc21 as decimal(30,2))+ CAST(w_hrs_ldc22 as decimal(30,2))+ CAST(w_hrs_ldc23 as decimal(30,2)) + CAST(w_hrs_ldc26 as decimal(30,2))+ CAST(w_hrs_ldc27 as decimal(30,2)) + CAST(w_hrs_ldc29 as decimal(30,2)))
                END tot_pct_ach,

                CASE WHEN SUM(cd_ern_hrs_ldc21)=0 OR SUM(w_cty_cupd)=0 OR SUM(w_hrs_ldc21+w_hrs_ldc29)=0
                THEN 0
                ELSE
                (CAST(SUM(w_cty_cupd) as decimal(18,2))/SUM(w_hrs_ldc21+w_hrs_ldc29))-(SUM(w_cty_cupd)/SUM(cd_ern_hrs_ldc21))
                END oei_var2earned,

                CASE WHEN SUM(w_cty_cupd)=0 OR SUM(w_hrs_ldc22)=0 THEN 0
                ELSE (CAST(SUM(w_cty_cupd) as decimal(18,2))/SUM(w_hrs_ldc22))-(b_sei_target)
                END sei_var2earned,

                CASE WHEN SUM(w_sply_dels)=0 OR SUM(w_sply_hrs)=0 OR SUM(w_hrs_ldc21+w_hrs_ldc22+w_hrs_ldc23+w_hrs_ldc24+w_hrs_ldc26+w_hrs_ldc27+w_hrs_ldc28+w_hrs_ldc29+w_hrs_ldc92)=0
                THEN 0 ELSE
                CASE WHEN CAST(SUM(w_sply_dels) as decimal(18,2))/SUM(w_sply_hrs)=0 OR CAST(SUM(w_cty_cupd) as decimal(18,2))/SUM(w_hrs_ldc21+w_hrs_ldc22+w_hrs_ldc23+w_hrs_ldc24+w_hrs_ldc26+w_hrs_ldc27+w_hrs_ldc28+w_hrs_ldc29+w_hrs_ldc92)=0 THEN 0
                                 ELSE ((CAST(SUM(w_cty_cupd) as decimal(18,2))/SUM(w_hrs_ldc21+w_hrs_ldc22+w_hrs_ldc23+w_hrs_ldc24+w_hrs_ldc26+w_hrs_ldc27+w_hrs_ldc28+w_hrs_ldc29+w_hrs_ldc92))-(CAST(SUM(w_sply_dels) as decimal(18,2))/SUM(w_sply_hrs)))/(CAST(SUM(w_sply_dels) as decimal(18,2))/SUM(w_sply_hrs))
                            END
                END dph2sply,

                CASE WHEN SUM(w_vol_dps_ltr)=0 THEN 0
                ELSE
                (CAST(SUM(w_vol_dps_ltr) as decimal(18,2))/SUM(w_vol_cas_ltr+w_vol_dps_ltr))
                END dps_pct,

                CASE WHEN SUM(w_vol_dps_flt)=0 THEN 0
                ELSE
                (CAST(SUM(w_vol_dps_flt) as decimal(18,2))/SUM(w_vol_cas_flt+w_vol_dps_flt))
                END fss_pct,

                CASE WHEN SUM(w_vol_dps_ltr+ w_vol_dps_flt + w_vol_cas_flt + w_vol_cas_ltr)=0
                THEN 0
                ELSE
                    SUM(w_vol_cas_flt + w_vol_cas_ltr)/CAST(SUM(w_vol_dps_ltr+ w_vol_dps_flt + w_vol_cas_flt + w_vol_cas_ltr) AS DECIMAL(18,2))
                END ManVolPct,

                CASE WHEN SUM(w_hrs_car_ot)=0 OR SUM(w_hrs_car_tot)=0 THEN 0
                ELSE
                (CAST(SUM(w_hrs_car_ot) AS DECIMAL(18,4))/(SUM(w_hrs_car_tot)))
                END ot_pct,

                CASE WHEN SUM(cd_ern_hrs_ldc21+cd_ern_hrs_ldc22+cd_ern_hrs_ldc26)=0 OR SUM(CAST(b_collection_unit_ind as tinyint))=1 THEN 0
                ELSE
                ((((dbo.var_base.b_hrs_ldc21 + dbo.var_base.b_hrs_ldc22 + dbo.var_base.b_hrs_ldc29 + CAST(dbo.var_base.b_car_rte_nbr AS DECIMAL(18, 2)) * 4 / dbo.var_annual.ann_del_days) / 8))-
                (((SUM(cd_ern_hrs_ldc21+cd_ern_hrs_ldc22+cd_ern_hrs_ldc26)*(prod_fters_fact))/sum(w_del_days))/8))
                END dly_fters_opp,

                CASE WHEN SUM(w_hrs_ldc21+w_hrs_ldc26+w_hrs_ldc29)=0 THEN 0
                ELSE
                ((((SUM(w_hrs_ldc21+w_hrs_ldc26+w_hrs_ldc29))-(SUM(cd_ern_hrs_ldc21+cd_ern_hrs_ldc26)))/sum(w_del_days))/8)
                END dly_ofc_opp,

                CASE WHEN SUM(w_hrs_ldc22+cd_ern_hrs_ldc22)=0 THEN 0
                ELSE
                (((SUM(w_hrs_ldc22)-SUM(cd_ern_hrs_ldc22))/sum(w_del_days))/8)
                END dly_str_opp,

                CASE WHEN SUM(w_hrs_ldc23+w_hrs_ldc27+cd_ern_hrs_ldc23+cd_ern_hrs_ldc27)=0 THEN 0
                ELSE
                (((SUM(w_hrs_ldc23+w_hrs_ldc27)-((ISNULL(SUM(cd_ern_hrs_ldc23+cd_ern_hrs_ldc27),0))))/sum(w_del_days))/8)
                END  dly_oth_opp,

                CASE WHEN SUM(w_hrs_ldc21+w_hrs_ldc26+w_hrs_ldc29+w_hrs_ldc23+w_hrs_ldc27)=0 THEN 0
                ELSE
                ((((SUM(w_hrs_ldc21+w_hrs_ldc26+w_hrs_ldc29))-(SUM(cd_ern_hrs_ldc21+cd_ern_hrs_ldc26)))/sum(w_del_days))/8)+
                (((SUM(w_hrs_ldc22)-SUM(cd_ern_hrs_ldc22))/sum(w_del_days))/8)+
                (((SUM(w_hrs_ldc23+w_hrs_ldc27)-((ISNULL(SUM(cd_ern_hrs_ldc23+cd_ern_hrs_ldc27),0))))/sum(w_del_days))/8)
                END dly_tot_opp,

                CASE WHEN SUM(w_cty_cupd)=0 OR SUM(w_hrs_ldc21+w_hrs_ldc29)=0 THEN 0 ELSE CAST(SUM(w_cty_cupd) AS DECIMAL(18,2))/SUM(w_hrs_ldc21+w_hrs_ldc29) END aoei,

                CASE WHEN SUM(w_cty_cupd)=0 OR SUM(w_hrs_ldc22)=0 THEN 0 ELSE (SUM(CAST(w_cty_cupd AS DECIMAL(18,4)))/SUM(w_hrs_ldc22)) END asei,

                CASE WHEN SUM(w_sply_dels)=0 OR SUM(w_hrs_ldc21sply+w_hrs_ldc29sply)=0 OR SUM(w_hrs_ldc21+w_hrs_ldc29)=0 THEN 0 ELSE CASE WHEN CAST(SUM(w_sply_dels) as decimal(30,2))/SUM(w_hrs_ldc21sply+w_hrs_ldc29sply)=0 OR CAST(SUM(w_cty_cupd) as decimal(30,2))/SUM(w_hrs_ldc21+w_hrs_ldc29)=0 THEN 0 ELSE ((CAST(SUM(w_cty_cupd) as decimal(30,2))/SUM(w_hrs_ldc21+w_hrs_ldc29))-(CAST(SUM(w_sply_dels) as decimal(30,2))/SUM(w_hrs_ldc21sply+w_hrs_ldc29sply)))/(CAST(SUM(w_sply_dels) as decimal(30,2))/SUM(w_hrs_ldc21sply+w_hrs_ldc29sply)) END END oei2sply,
                CASE WHEN SUM(w_sply_dels)=0 OR SUM(w_hrs_ldc22sply)=0 OR SUM(w_hrs_ldc22)=0 THEN 0 ELSE CASE WHEN CAST(SUM(w_sply_dels) as decimal(30,2))/SUM(w_hrs_ldc22sply)=0 OR CAST(SUM(w_cty_cupd) as decimal(30,2))/SUM(w_hrs_ldc22)=0 THEN 0 ELSE ((CAST(SUM(w_cty_cupd) as decimal(30,2))/SUM(w_hrs_ldc22))-(CAST(SUM(w_sply_dels) as decimal(30,2))/SUM(w_hrs_ldc22sply)))/(CAST(SUM(w_sply_dels) as decimal(30,2))/SUM(w_hrs_ldc22sply)) END END sei2sply,

                (SUM(cd_ern_f2b_hrs_tot)/sum(w_del_days))/8 cd_ern_routes,
                SUM(w_cty_rte)/COUNT(w_wk) w_cty_rte,
                isnull(TotWebCoinsCarriers,0) TotWebCoinsCarriers   -- 042214 GDW change NULLs to zero for Callie Grett complaint

                FROM var_base WITH(NOLOCK),var_weekly WITH(NOLOCK),var_calc_cdv WITH(NOLOCK),
                #APPLICATION.dsn2#.dbo.avar_cdv_prod WITH(NOLOCK),var_annual with(nolock),vw_TotalCarriers
                WHERE b_fin_nbr=w_fin_nbr
                    AND b_fin_nbr=calc_fin_nbr
                    AND b_fin_nbr=c_fin_nbr
                    AND w_fy=calc_fy
                    AND w_wk=calc_wk
                    AND b_cdv_ind = 1
                    AND b_mpoo != 'X'
                AND #PreserveSingleQuotes(ARGUMENTS.sqlWhere)# <!--- AND b_scf_ind=1 --->
                AND ((calc_fy * 100) + calc_wk) BETWEEN #ARGUMENTS.begFYWk# AND #ARGUMENTS.endFYWk#
                GROUP BY b_dois_ind, b_fin_nbr, b_level, b_fin_name,b_cluster, b_mpoo, b_hrs_fot_w_brk,prod_fters_fact,b_sei_target,
                         b_collection_unit_ind,b_cluster_name,b_car_rte_nbr,ann_del_days,b_hrs_ldc21,b_hrs_ldc22,b_hrs_ldc29,
                         b_sei_prev_yr,TotWebCoinsCarriers, b_fss_ind, b_dps_ind, b_rto_ind
                ORDER BY dly_tot_opp desc










CASE
        WHEN SUM(CAST(w.w_del_days AS DECIMAL(30,2))) = 0 THEN 0
        WHEN SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc26 + w.w_hrs_ldc29
                     + w.w_hrs_ldc22
                     + w.w_hrs_ldc23 + w.w_hrs_ldc27 AS DECIMAL(30,2))) = 0
        THEN 0
        ELSE
            /* Office Opp (FTER) */
            (
                (
                    SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc26 + w.w_hrs_ldc29 AS DECIMAL(30,2)))
                  - SUM(CAST(calc.cd_ern_hrs_ldc21 + calc.cd_ern_hrs_ldc26 AS DECIMAL(30,2)))
                )
                / NULLIF(SUM(CAST(w.w_del_days AS DECIMAL(30,2))), 0)
            ) / 8.0

            +

            /* Street Opp (FTER) */
            (
                (
                    SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)))
                  - SUM(CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,2)))
                )
                / NULLIF(SUM(CAST(w.w_del_days AS DECIMAL(30,2))), 0)
            ) / 8.0

            +

            /* Other Opp (FTER) */
            (
                (
                    SUM(CAST(w.w_hrs_ldc23 + w.w_hrs_ldc27 AS DECIMAL(30,2)))
                  - ISNULL(SUM(CAST(calc.cd_ern_hrs_ldc23 + calc.cd_ern_hrs_ldc27 AS DECIMAL(30,2))), 0)
                )
                / NULLIF(SUM(CAST(w.w_del_days AS DECIMAL(30,2))), 0)
            ) / 8.0
    END AS dly_tot_opp,








/* Set your FYWK range */
DECLARE @begFYWk INT = 202501;   -- YYYYWW (example)
DECLARE @endFYWk INT = 202552;   -- YYYYWW (example)

SELECT
    b.b_area,
    b.b_area_name,

    CASE
        WHEN SUM(CAST(b.b_sei_ldc22 AS DECIMAL(30,2))) = 0 THEN 0
        ELSE SUM(CAST(b.b_sei_del  AS DECIMAL(30,2))) / SUM(CAST(b.b_sei_ldc22 AS DECIMAL(30,2)))
    END AS B_SEI_PREV_YR,

    CASE
        WHEN SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_vol_cas_ltr              AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_vol_cas_flt              AS DECIMAL(30,2))) = 0
        THEN 0
        ELSE
            SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2)))
            /
            (
                (
                    (
                        ( SUM(CAST(w.w_vol_cas_ltr AS DECIMAL(30,2))) / 18.0 )
                      + ( SUM(CAST(w.w_vol_cas_flt AS DECIMAL(30,2))) /  8.0 )
                      + ( (SUM(CAST(w.w_vol_cas_ltr AS DECIMAL(30,2))) + SUM(CAST(w.w_vol_cas_flt AS DECIMAL(30,2))))
                          / 70.0
                        )
                    ) / 60.0
                )
                + SUM(CAST(b.b_hrs_fot_w_brk * w.w_del_days AS DECIMAL(30,2)))
            )
    END AS act_pct_standard,

    CASE
        WHEN SUM(
            CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
          + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2))
        ) = 0 THEN 0
        ELSE
            (
                SUM(CAST(calc.cd_ern_hrs_ldc21 AS DECIMAL(30,2))) + SUM(CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,2)))
              + SUM(CAST(calc.cd_ern_hrs_ldc23 AS DECIMAL(30,2))) + SUM(CAST(calc.cd_ern_hrs_ldc26 AS DECIMAL(30,2)))
              + SUM(CAST(calc.cd_ern_hrs_ldc27 AS DECIMAL(30,2))) + SUM(CAST(calc.cd_ern_hrs_ldc29 AS DECIMAL(30,2)))
            )
            /
            SUM(
                CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
              + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2))
            )
    END AS tot_pct_ach,

    CASE
        WHEN SUM(CAST(calc.cd_ern_hrs_ldc21 AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_cty_cupd         AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2))) = 0
        THEN 0
        ELSE
            (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2))))
          - (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2))))
    END AS oei_var2earned,

    CASE
        WHEN SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_sply_hrs  AS DECIMAL(30,2))) = 0
          OR SUM(
                CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
              + CAST(w.w_hrs_ldc24 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2))
              + CAST(w.w_hrs_ldc28 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc92 AS DECIMAL(30,2))
            ) = 0
        THEN 0
        ELSE
            CASE
                WHEN (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_sply_hrs AS DECIMAL(30,2)))) = 0
                  OR (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) /
                      SUM(
                          CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
                        + CAST(w.w_hrs_ldc24 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2))
                        + CAST(w.w_hrs_ldc28 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc92 AS DECIMAL(30,2))
                      )
                     ) = 0
                THEN 0
                ELSE
                    (
                        (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) /
                         SUM(
                             CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
                           + CAST(w.w_hrs_ldc24 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2))
                           + CAST(w.w_hrs_ldc28 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc92 AS DECIMAL(30,2))
                         )
                        )
                      - (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_sply_hrs AS DECIMAL(30,2))))
                    )
                    /
                    (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_sply_hrs AS DECIMAL(30,2))))
            END
    END AS dph2sply,

    CASE
        WHEN SUM(CAST(w.w_vol_dps_ltr AS DECIMAL(30,2))) = 0 THEN 0
        ELSE SUM(CAST(w.w_vol_dps_ltr AS DECIMAL(30,2)))
             / SUM(CAST(w.w_vol_cas_ltr + w.w_vol_dps_ltr AS DECIMAL(30,2)))
    END AS dps_pct,

    CASE
        WHEN SUM(CAST(w.w_vol_dps_flt AS DECIMAL(30,2))) = 0 THEN 0
        ELSE SUM(CAST(w.w_vol_dps_flt AS DECIMAL(30,2)))
             / SUM(CAST(w.w_vol_cas_flt + w.w_vol_dps_flt AS DECIMAL(30,2)))
    END AS fss_pct,

    CASE
        WHEN SUM(CAST(w.w_vol_dps_ltr + w.w_vol_dps_flt + w.w_vol_cas_flt + w.w_vol_cas_ltr AS BIGINT)) = 0 THEN 0
        ELSE
            SUM(CAST(w.w_vol_cas_flt + w.w_vol_cas_ltr AS BIGINT))
            / SUM(CAST(w.w_vol_dps_ltr + w.w_vol_dps_flt + w.w_vol_cas_flt + w.w_vol_cas_ltr AS DECIMAL(30,4)))
    END AS ManVolPct,

    CASE
        WHEN SUM(CAST(w.w_hrs_car_ot  AS DECIMAL(30,4))) = 0
          OR SUM(CAST(w.w_hrs_car_tot AS DECIMAL(30,4))) = 0
        THEN 0
        ELSE SUM(CAST(w.w_hrs_car_ot AS DECIMAL(30,4))) / SUM(CAST(w.w_hrs_car_tot AS DECIMAL(30,4)))
    END AS ot_pct,

    CASE
        WHEN SUM(
               CAST(calc.cd_ern_hrs_ldc21 AS DECIMAL(30,2))
             + CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,2))
             + CAST(calc.cd_ern_hrs_ldc26 AS DECIMAL(30,2))
             ) = 0
          OR SUM(CAST(b.b_collection_unit_ind AS TINYINT)) = 1
        THEN 0
        ELSE
            (
                (
                    (
                        SUM(
                            CAST(b.b_hrs_ldc21 * w.w_del_days AS DECIMAL(30,8))
                          + CAST(b.b_hrs_ldc22 * w.w_del_days AS DECIMAL(30,8))
                          + CAST(b.b_hrs_ldc29 * w.w_del_days AS DECIMAL(30,8))
                        )
                      + (SUM(CAST(b.b_car_rte_nbr * w.w_del_days AS DECIMAL(30,8))) * 4.0 / CAST(ann.ann_del_days AS DECIMAL(30,8)))
                    )
                  - (
                        SUM(
                            CAST(calc.cd_ern_hrs_ldc21 AS DECIMAL(30,8))
                          + CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,8))
                          + CAST(calc.cd_ern_hrs_ldc26 AS DECIMAL(30,8))
                        )
                        * CAST(prod.prod_fters_fact AS DECIMAL(30,8))
                    )
                ) / 8.0
            ) / SUM(w.w_del_days)
    END AS dly_fters_opp,

    CASE
        WHEN SUM(CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2))) = 0 THEN 0
        ELSE
            (
                (
                    SUM(CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2)))
                  - SUM(CAST(calc.cd_ern_hrs_ldc21 AS DECIMAL(30,2)) + CAST(calc.cd_ern_hrs_ldc26 AS DECIMAL(30,2)))
                )
                / SUM(w.w_del_days)
            ) / 8.0
    END AS dly_ofc_opp,

    CASE
        WHEN SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,2))) = 0 THEN 0
        ELSE
            (
                (SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2))) - SUM(CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,2))))
                / SUM(w.w_del_days)
            ) / 8.0
    END AS dly_str_opp,

    CASE
        WHEN SUM(CAST(w.w_hrs_ldc23 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2))
               + CAST(calc.cd_ern_hrs_ldc23 AS DECIMAL(30,2)) + CAST(calc.cd_ern_hrs_ldc27 AS DECIMAL(30,2))) = 0 THEN 0
        ELSE
            (
                (
                    SUM(CAST(w.w_hrs_ldc23 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2)))
                  - ISNULL(SUM(CAST(calc.cd_ern_hrs_ldc23 AS DECIMAL(30,2)) + CAST(calc.cd_ern_hrs_ldc27 AS DECIMAL(30,2))), 0)
                )
                / SUM(w.w_del_days)
            ) / 8.0
    END AS dly_oth_opp,

    CASE
        WHEN SUM(CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2))
               + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2))) = 0 THEN 0
        ELSE
            (
                (
                    (
                        (
                            SUM(CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2)))
                          - SUM(CAST(calc.cd_ern_hrs_ldc21 AS DECIMAL(30,2)) + CAST(calc.cd_ern_hrs_ldc26 AS DECIMAL(30,2)))
                        ) / SUM(w.w_del_days)
                    ) / 8.0
                )
              + (
                    ((SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2))) - SUM(CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,2)))) / SUM(w.w_del_days)) / 8.0
                )
              + (
                    ((SUM(CAST(w.w_hrs_ldc23 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2)))
                      - ISNULL(SUM(CAST(calc.cd_ern_hrs_ldc23 AS DECIMAL(30,2)) + CAST(calc.cd_ern_hrs_ldc27 AS DECIMAL(30,2))), 0)
                     ) / SUM(w.w_del_days)
                    ) / 8.0
                )
    END AS dly_tot_opp,

    CASE
        WHEN SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2))) = 0
        THEN 0
        ELSE SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2)))
    END AS aoei,

    CASE
        WHEN SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2))) = 0
        THEN 0
        ELSE SUM(CAST(w.w_cty_cupd AS DECIMAL(30,4))) / SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)))
    END AS asei,

    CASE
        WHEN SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_hrs_ldc21sply + w.w_hrs_ldc29sply AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2))) = 0
        THEN 0
        ELSE
            CASE
                WHEN (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21sply + w.w_hrs_ldc29sply AS DECIMAL(30,2)))) = 0
                  OR (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2)))) = 0
                THEN 0
                ELSE
                    (
                        (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2))))
                      - (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21sply + w.w_hrs_ldc29sply AS DECIMAL(30,2))))
                    )
                    /
                    (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21sply + w.w_hrs_ldc29sply AS DECIMAL(30,2))))
            END
    END AS oei2sply,

    CASE
        WHEN SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_hrs_ldc22sply AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2))) = 0
        THEN 0
        ELSE
            CASE
                WHEN (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc22sply AS DECIMAL(30,2)))) = 0
                  OR (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)))) = 0
                THEN 0
                ELSE
                    (
                        (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2))))
                      - (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc22sply AS DECIMAL(30,2))))
                    )
                    /
                    (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc22sply AS DECIMAL(30,2))))
            END
    END AS sei2sply,

    (SUM(calc.cd_ern_f2b_hrs_tot) / SUM(w.w_del_days)) / 8.0 AS cd_ern_routes,
    SUM(w.w_cty_rte) / NULLIF(COUNT(w.w_wk), 0)               AS w_cty_rte,
    SUM(tc.TotWebCoinsCarriers) / NULLIF(COUNT(w.w_wk), 0)    AS TotWebCoinsCarriers

FROM dbo.var_base b WITH (NOLOCK)
JOIN dbo.var_weekly w WITH (NOLOCK)
    ON b.b_fin_nbr = w.w_fin_nbr
JOIN dbo.var_calc_cdv calc WITH (NOLOCK)
    ON b.b_fin_nbr = calc.calc_fin_nbr
   AND w.w_fy      = calc.calc_fy
   AND w.w_wk      = calc.calc_wk
JOIN dbo.vw_TotalCarriers tc
    ON b.b_fin_nbr = tc.c_fin_nbr

-- replaced CROSS JOIN ... WITH (NOLOCK)
JOIN [PCDV_Delpvar].dbo.avar_cdv_prod prod WITH (NOLOCK) ON 1 = 1
JOIN dbo.var_annual ann WITH (NOLOCK)                   ON 1 = 1

WHERE
    b.b_cdv_ind = 1
    AND b.b_mpoo <> 'X'
    AND ((w.w_fy * 100) + w.w_wk) BETWEEN @begFYWk AND @endFYWk

GROUP BY
    b.b_area,
    b.b_area_name,
    prod.prod_fters_fact,
    ann.ann_del_days

ORDER BY
    dly_tot_opp DESC;

























/* Set your FYWK range */
DECLARE @begFYWk INT = 202501;   -- YYYYWW (example)
DECLARE @endFYWk INT = 202552;   -- YYYYWW (example)

/* NOTE: Replace [DSN2_DB] with the actual database that contains dbo.avar_cdv_prod */
SELECT
    b.b_area,
    b.b_area_name,

    CASE
        WHEN SUM(CAST(b.b_sei_ldc22 AS DECIMAL(30,2))) = 0 THEN 0
        ELSE SUM(CAST(b.b_sei_del  AS DECIMAL(30,2))) / SUM(CAST(b.b_sei_ldc22 AS DECIMAL(30,2)))
    END AS B_SEI_PREV_YR,

    CASE
        WHEN SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_vol_cas_ltr              AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_vol_cas_flt              AS DECIMAL(30,2))) = 0
        THEN 0
        ELSE
            SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2)))
            /
            (
                (
                    (
                        ( SUM(CAST(w.w_vol_cas_ltr AS DECIMAL(30,2))) / 18.0 )
                      + ( SUM(CAST(w.w_vol_cas_flt AS DECIMAL(30,2))) /  8.0 )
                      + ( (SUM(CAST(w.w_vol_cas_ltr AS DECIMAL(30,2))) + SUM(CAST(w.w_vol_cas_flt AS DECIMAL(30,2))))
                          / 70.0
                        )
                    ) / 60.0
                )
                + SUM(CAST(b.b_hrs_fot_w_brk * w.w_del_days AS DECIMAL(30,2)))
            )
    END AS act_pct_standard,

    CASE
        WHEN SUM(
            CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
          + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2))
        ) = 0 THEN 0
        ELSE
            (
                SUM(CAST(calc.cd_ern_hrs_ldc21 AS DECIMAL(30,2))) + SUM(CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,2)))
              + SUM(CAST(calc.cd_ern_hrs_ldc23 AS DECIMAL(30,2))) + SUM(CAST(calc.cd_ern_hrs_ldc26 AS DECIMAL(30,2)))
              + SUM(CAST(calc.cd_ern_hrs_ldc27 AS DECIMAL(30,2))) + SUM(CAST(calc.cd_ern_hrs_ldc29 AS DECIMAL(30,2)))
            )
            /
            SUM(
                CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
              + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2))
            )
    END AS tot_pct_ach,

    CASE
        WHEN SUM(CAST(calc.cd_ern_hrs_ldc21 AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_cty_cupd         AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2))) = 0
        THEN 0
        ELSE
            (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2))))
          - (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2))))
    END AS oei_var2earned,

    CASE
        WHEN SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_sply_hrs  AS DECIMAL(30,2))) = 0
          OR SUM(
                CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
              + CAST(w.w_hrs_ldc24 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2))
              + CAST(w.w_hrs_ldc28 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc92 AS DECIMAL(30,2))
            ) = 0
        THEN 0
        ELSE
            CASE
                WHEN (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_sply_hrs AS DECIMAL(30,2)))) = 0
                  OR (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) /
                      SUM(
                          CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
                        + CAST(w.w_hrs_ldc24 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2))
                        + CAST(w.w_hrs_ldc28 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc92 AS DECIMAL(30,2))
                      )
                     ) = 0
                THEN 0
                ELSE
                    (
                        (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) /
                         SUM(
                             CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
                           + CAST(w.w_hrs_ldc24 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2))
                           + CAST(w.w_hrs_ldc28 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc92 AS DECIMAL(30,2))
                         )
                        )
                      - (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_sply_hrs AS DECIMAL(30,2))))
                    )
                    /
                    (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_sply_hrs AS DECIMAL(30,2))))
            END
    END AS dph2sply,

    CASE
        WHEN SUM(CAST(w.w_vol_dps_ltr AS DECIMAL(30,2))) = 0 THEN 0
        ELSE SUM(CAST(w.w_vol_dps_ltr AS DECIMAL(30,2)))
             / SUM(CAST(w.w_vol_cas_ltr + w.w_vol_dps_ltr AS DECIMAL(30,2)))
    END AS dps_pct,

    CASE
        WHEN SUM(CAST(w.w_vol_dps_flt AS DECIMAL(30,2))) = 0 THEN 0
        ELSE SUM(CAST(w.w_vol_dps_flt AS DECIMAL(30,2)))
             / SUM(CAST(w.w_vol_cas_flt + w.w_vol_dps_flt AS DECIMAL(30,2)))
    END AS fss_pct,

    CASE
        WHEN SUM(CAST(w.w_vol_dps_ltr + w.w_vol_dps_flt + w.w_vol_cas_flt + w.w_vol_cas_ltr AS BIGINT)) = 0 THEN 0
        ELSE
            SUM(CAST(w.w_vol_cas_flt + w.w_vol_cas_ltr AS BIGINT))
            / SUM(CAST(w.w_vol_dps_ltr + w.w_vol_dps_flt + w.w_vol_cas_flt + w.w_vol_cas_ltr AS DECIMAL(30,4)))
    END AS ManVolPct,

    CASE
        WHEN SUM(CAST(w.w_hrs_car_ot  AS DECIMAL(30,4))) = 0
          OR SUM(CAST(w.w_hrs_car_tot AS DECIMAL(30,4))) = 0
        THEN 0
        ELSE SUM(CAST(w.w_hrs_car_ot AS DECIMAL(30,4))) / SUM(CAST(w.w_hrs_car_tot AS DECIMAL(30,4)))
    END AS ot_pct,

    CASE
        WHEN SUM(CAST(calc.cd_ern_hrs_ldc21 AS DECIMAL(30,2))
               + CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,2))
               + CAST(calc.cd_ern_hrs_ldc26 AS DECIMAL(30,2))) = 0
          OR SUM(CAST(b.b_collection_unit_ind AS TINYINT)) = 1
        THEN 0
        ELSE
            (
                (
                    (
                        SUM(
                            CAST(b.b_hrs_ldc21 * w.w_del_days AS DECIMAL(30,8))
                          + CAST(b.b_hrs_ldc22 * w.w_del_days AS DECIMAL(30,8))
                          + CAST(b.b_hrs_ldc29 * w.w_del_days AS DECIMAL(30,8))
                        )
                      + (SUM(CAST(b.b_car_rte_nbr * w.w_del_days AS DECIMAL(30,8))) * 4.0 / CAST(ann.ann_del_days AS DECIMAL(30,8)))
                    )
                  - (
                        SUM(
                            CAST(calc.cd_ern_hrs_ldc21 AS DECIMAL(30,8))
                          + CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,8))
                          + CAST(calc.cd_ern_hrs_ldc26 AS DECIMAL(30,8))
                        )
                        * CAST(prod.prod_fters_fact AS DECIMAL(30,8))
                    )
                ) / 8.0
            ) / SUM(w.w_del_days)
    END AS dly_fters_opp,

    CASE
        WHEN SUM(CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2))) = 0 THEN 0
        ELSE
            (
                (
                    SUM(CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2)))
                  - SUM(CAST(calc.cd_ern_hrs_ldc21 AS DECIMAL(30,2)) + CAST(calc.cd_ern_hrs_ldc26 AS DECIMAL(30,2)))
                )
                / SUM(w.w_del_days)
            ) / 8.0
    END AS dly_ofc_opp,

    CASE
        WHEN SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,2))) = 0 THEN 0
        ELSE
            (
                (SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2))) - SUM(CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,2))))
                / SUM(w.w_del_days)
            ) / 8.0
    END AS dly_str_opp,

    CASE
        WHEN SUM(CAST(w.w_hrs_ldc23 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2))
               + CAST(calc.cd_ern_hrs_ldc23 AS DECIMAL(30,2)) + CAST(calc.cd_ern_hrs_ldc27 AS DECIMAL(30,2))) = 0 THEN 0
        ELSE
            (
                (
                    SUM(CAST(w.w_hrs_ldc23 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2)))
                  - ISNULL(SUM(CAST(calc.cd_ern_hrs_ldc23 AS DECIMAL(30,2)) + CAST(calc.cd_ern_hrs_ldc27 AS DECIMAL(30,2))), 0)
                )
                / SUM(w.w_del_days)
            ) / 8.0
    END AS dly_oth_opp,

    CASE
        WHEN SUM(CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2))
               + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2))) = 0 THEN 0
        ELSE
            (
                (
                    (
                        (
                            SUM(CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2)))
                          - SUM(CAST(calc.cd_ern_hrs_ldc21 AS DECIMAL(30,2)) + CAST(calc.cd_ern_hrs_ldc26 AS DECIMAL(30,2)))
                        ) / SUM(w.w_del_days)
                    ) / 8.0
                )
              + (
                    ((SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2))) - SUM(CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,2)))) / SUM(w.w_del_days)) / 8.0
                )
              + (
                    ((SUM(CAST(w.w_hrs_ldc23 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2)))
                      - ISNULL(SUM(CAST(calc.cd_ern_hrs_ldc23 AS DECIMAL(30,2)) + CAST(calc.cd_ern_hrs_ldc27 AS DECIMAL(30,2))), 0)
                     ) / SUM(w.w_del_days)
                    ) / 8.0
                )
    END AS dly_tot_opp,

    CASE
        WHEN SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2))) = 0
        THEN 0
        ELSE SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2)))
    END AS aoei,

    CASE
        WHEN SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2))) = 0
        THEN 0
        ELSE SUM(CAST(w.w_cty_cupd AS DECIMAL(30,4))) / SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)))
    END AS asei,

    CASE
        WHEN SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_hrs_ldc21sply + w.w_hrs_ldc29sply AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2))) = 0
        THEN 0
        ELSE
            CASE
                WHEN (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21sply + w.w_hrs_ldc29sply AS DECIMAL(30,2)))) = 0
                  OR (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2)))) = 0
                THEN 0
                ELSE
                    (
                        (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2))))
                      - (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21sply + w.w_hrs_ldc29sply AS DECIMAL(30,2))))
                    )
                    /
                    (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21sply + w.w_hrs_ldc29sply AS DECIMAL(30,2))))
            END
    END AS oei2sply,

    CASE
        WHEN SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_hrs_ldc22sply AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2))) = 0
        THEN 0
        ELSE
            CASE
                WHEN (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc22sply AS DECIMAL(30,2)))) = 0
                  OR (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)))) = 0
                THEN 0
                ELSE
                    (
                        (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2))))
                      - (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc22sply AS DECIMAL(30,2))))
                    )
                    /
                    (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc22sply AS DECIMAL(30,2))))
            END
    END AS sei2sply,

    (SUM(calc.cd_ern_f2b_hrs_tot) / SUM(w.w_del_days)) / 8.0 AS cd_ern_routes,
    SUM(w.w_cty_rte) / NULLIF(COUNT(w.w_wk), 0)          AS w_cty_rte,
    SUM(tc.TotWebCoinsCarriers) / NULLIF(COUNT(w.w_wk), 0) AS TotWebCoinsCarriers

FROM dbo.var_base b WITH (NOLOCK)
JOIN dbo.var_weekly w WITH (NOLOCK)
    ON b.b_fin_nbr = w.w_fin_nbr
JOIN dbo.var_calc_cdv calc WITH (NOLOCK)
    ON b.b_fin_nbr = calc.calc_fin_nbr
   AND w.w_fy      = calc.calc_fy
   AND w.w_wk      = calc.calc_wk
JOIN dbo.vw_TotalCarriers tc
    ON b.b_fin_nbr = tc.c_fin_nbr
CROSS JOIN [PCDV_Delpvar].dbo.avar_cdv_prod prod WITH (NOLOCK)
CROSS JOIN dbo.var_annual ann WITH (NOLOCK)

WHERE
    b.b_cdv_ind = 1
    AND b.b_mpoo <> 'X'
    AND ((w.w_fy * 100) + w.w_wk) BETWEEN @begFYWk AND @endFYWk

GROUP BY
    b.b_area,
    b.b_area_name,
    prod.prod_fters_fact,
    ann.ann_del_days

ORDER BY
    dly_tot_opp DESC;





























/* Set your FYWK range */
DECLARE @begFYWk INT = 202501;   -- YYYYWW (example)
DECLARE @endFYWk INT = 202552;   -- YYYYWW (example)

/* NOTE: Replace [DSN2_DB] with the actual database that contains dbo.avar_cdv_prod */
SELECT
    b.b_area,
    b.b_area_name,

    CASE
        WHEN SUM(CAST(b.b_sei_ldc22 AS DECIMAL(30,2))) = 0 THEN 0
        ELSE SUM(CAST(b.b_sei_del  AS DECIMAL(30,2))) / SUM(CAST(b.b_sei_ldc22 AS DECIMAL(30,2)))
    END AS B_SEI_PREV_YR,

    CASE
        WHEN SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_vol_cas_ltr              AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_vol_cas_flt              AS DECIMAL(30,2))) = 0
        THEN 0
        ELSE
            SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2)))
            /
            (
                (
                    (
                        ( SUM(CAST(w.w_vol_cas_ltr AS DECIMAL(30,2))) / 18.0 )
                      + ( SUM(CAST(w.w_vol_cas_flt AS DECIMAL(30,2))) /  8.0 )
                      + ( (SUM(CAST(w.w_vol_cas_ltr AS DECIMAL(30,2))) + SUM(CAST(w.w_vol_cas_flt AS DECIMAL(30,2))))
                          / 70.0
                        )
                    ) / 60.0
                )
                + SUM(CAST(b.b_hrs_fot_w_brk * w.w_del_days AS DECIMAL(30,2)))
            )
    END AS act_pct_standard,

    CASE
        WHEN SUM(
            CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
          + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2))
        ) = 0 THEN 0
        ELSE
            (
                SUM(CAST(calc.cd_ern_hrs_ldc21 AS DECIMAL(30,2))) + SUM(CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,2)))
              + SUM(CAST(calc.cd_ern_hrs_ldc23 AS DECIMAL(30,2))) + SUM(CAST(calc.cd_ern_hrs_ldc26 AS DECIMAL(30,2)))
              + SUM(CAST(calc.cd_ern_hrs_ldc27 AS DECIMAL(30,2))) + SUM(CAST(calc.cd_ern_hrs_ldc29 AS DECIMAL(30,2)))
            )
            /
            SUM(
                CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
              + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2))
            )
    END AS tot_pct_ach,

    CASE
        WHEN SUM(CAST(calc.cd_ern_hrs_ldc21 AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_cty_cupd         AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2))) = 0
        THEN 0
        ELSE
            (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2))))
          - (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2))))
    END AS oei_var2earned,

    CASE
        WHEN SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_sply_hrs  AS DECIMAL(30,2))) = 0
          OR SUM(
                CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
              + CAST(w.w_hrs_ldc24 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2))
              + CAST(w.w_hrs_ldc28 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc92 AS DECIMAL(30,2))
            ) = 0
        THEN 0
        ELSE
            CASE
                WHEN (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_sply_hrs AS DECIMAL(30,2)))) = 0
                  OR (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) /
                      SUM(
                          CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
                        + CAST(w.w_hrs_ldc24 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2))
                        + CAST(w.w_hrs_ldc28 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc92 AS DECIMAL(30,2))
                      )
                     ) = 0
                THEN 0
                ELSE
                    (
                        (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) /
                         SUM(
                             CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2))
                           + CAST(w.w_hrs_ldc24 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2))
                           + CAST(w.w_hrs_ldc28 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc92 AS DECIMAL(30,2))
                         )
                        )
                      - (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_sply_hrs AS DECIMAL(30,2))))
                    )
                    /
                    (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_sply_hrs AS DECIMAL(30,2))))
            END
    END AS dph2sply,

    CASE
        WHEN SUM(CAST(w.w_vol_dps_ltr AS DECIMAL(30,2))) = 0 THEN 0
        ELSE SUM(CAST(w.w_vol_dps_ltr AS DECIMAL(30,2)))
             / SUM(CAST(w.w_vol_cas_ltr + w.w_vol_dps_ltr AS DECIMAL(30,2)))
    END AS dps_pct,

    CASE
        WHEN SUM(CAST(w.w_vol_dps_flt AS DECIMAL(30,2))) = 0 THEN 0
        ELSE SUM(CAST(w.w_vol_dps_flt AS DECIMAL(30,2)))
             / SUM(CAST(w.w_vol_cas_flt + w.w_vol_dps_flt AS DECIMAL(30,2)))
    END AS fss_pct,

    CASE
        WHEN SUM(CAST(w.w_vol_dps_ltr + w.w_vol_dps_flt + w.w_vol_cas_flt + w.w_vol_cas_ltr AS BIGINT)) = 0 THEN 0
        ELSE
            SUM(CAST(w.w_vol_cas_flt + w.w_vol_cas_ltr AS BIGINT))
            / SUM(CAST(w.w_vol_dps_ltr + w.w_vol_dps_flt + w.w_vol_cas_flt + w.w_vol_cas_ltr AS DECIMAL(30,4)))
    END AS ManVolPct,

    CASE
        WHEN SUM(CAST(w.w_hrs_car_ot  AS DECIMAL(30,4))) = 0
          OR SUM(CAST(w.w_hrs_car_tot AS DECIMAL(30,4))) = 0
        THEN 0
        ELSE SUM(CAST(w.w_hrs_car_ot AS DECIMAL(30,4))) / SUM(CAST(w.w_hrs_car_tot AS DECIMAL(30,4)))
    END AS ot_pct,

    CASE
        WHEN SUM(CAST(calc.cd_ern_hrs_ldc21 AS DECIMAL(30,2))
               + CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,2))
               + CAST(calc.cd_ern_hrs_ldc26 AS DECIMAL(30,2))) = 0
          OR SUM(CAST(b.b_collection_unit_ind AS TINYINT)) = 1
        THEN 0
        ELSE
            (
                (
                    (
                        SUM(
                            CAST(b.b_hrs_ldc21 * w.w_del_days AS DECIMAL(30,8))
                          + CAST(b.b_hrs_ldc22 * w.w_del_days AS DECIMAL(30,8))
                          + CAST(b.b_hrs_ldc29 * w.w_del_days AS DECIMAL(30,8))
                        )
                      + (SUM(CAST(b.b_car_rte_nbr * w.w_del_days AS DECIMAL(30,8))) * 4.0 / CAST(ann.ann_del_days AS DECIMAL(30,8)))
                    )
                  - (
                        SUM(
                            CAST(calc.cd_ern_hrs_ldc21 AS DECIMAL(30,8))
                          + CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,8))
                          + CAST(calc.cd_ern_hrs_ldc26 AS DECIMAL(30,8))
                        )
                        * CAST(prod.prod_fters_fact AS DECIMAL(30,8))
                    )
                ) / 8.0
            ) / SUM(w.w_del_days)
    END AS dly_fters_opp,

    CASE
        WHEN SUM(CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2))) = 0 THEN 0
        ELSE
            (
                (
                    SUM(CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2)))
                  - SUM(CAST(calc.cd_ern_hrs_ldc21 AS DECIMAL(30,2)) + CAST(calc.cd_ern_hrs_ldc26 AS DECIMAL(30,2)))
                )
                / SUM(w.w_del_days)
            ) / 8.0
    END AS dly_ofc_opp,

    CASE
        WHEN SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)) + CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,2))) = 0 THEN 0
        ELSE
            (
                (SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2))) - SUM(CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,2))))
                / SUM(w.w_del_days)
            ) / 8.0
    END AS dly_str_opp,

    CASE
        WHEN SUM(CAST(w.w_hrs_ldc23 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2))
               + CAST(calc.cd_ern_hrs_ldc23 AS DECIMAL(30,2)) + CAST(calc.cd_ern_hrs_ldc27 AS DECIMAL(30,2))) = 0 THEN 0
        ELSE
            (
                (
                    SUM(CAST(w.w_hrs_ldc23 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2)))
                  - ISNULL(SUM(CAST(calc.cd_ern_hrs_ldc23 AS DECIMAL(30,2)) + CAST(calc.cd_ern_hrs_ldc27 AS DECIMAL(30,2))), 0)
                )
                / SUM(w.w_del_days)
            ) / 8.0
    END AS dly_oth_opp,

    CASE
        WHEN SUM(CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2))
               + CAST(w.w_hrs_ldc23 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2))) = 0 THEN 0
        ELSE
            (
                (
                    (
                        (
                            SUM(CAST(w.w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc26 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc29 AS DECIMAL(30,2)))
                          - SUM(CAST(calc.cd_ern_hrs_ldc21 AS DECIMAL(30,2)) + CAST(calc.cd_ern_hrs_ldc26 AS DECIMAL(30,2)))
                        ) / SUM(w.w_del_days)
                    ) / 8.0
                )
              + (
                    ((SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2))) - SUM(CAST(calc.cd_ern_hrs_ldc22 AS DECIMAL(30,2)))) / SUM(w.w_del_days)) / 8.0
                )
              + (
                    ((SUM(CAST(w.w_hrs_ldc23 AS DECIMAL(30,2)) + CAST(w.w_hrs_ldc27 AS DECIMAL(30,2)))
                      - ISNULL(SUM(CAST(calc.cd_ern_hrs_ldc23 AS DECIMAL(30,2)) + CAST(calc.cd_ern_hrs_ldc27 AS DECIMAL(30,2))), 0)
                     ) / SUM(w.w_del_days)
                    ) / 8.0
                )
    END AS dly_tot_opp,

    CASE
        WHEN SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2))) = 0
        THEN 0
        ELSE SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2)))
    END AS aoei,

    CASE
        WHEN SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2))) = 0
        THEN 0
        ELSE SUM(CAST(w.w_cty_cupd AS DECIMAL(30,4))) / SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)))
    END AS asei,

    CASE
        WHEN SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_hrs_ldc21sply + w.w_hrs_ldc29sply AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2))) = 0
        THEN 0
        ELSE
            CASE
                WHEN (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21sply + w.w_hrs_ldc29sply AS DECIMAL(30,2)))) = 0
                  OR (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2)))) = 0
                THEN 0
                ELSE
                    (
                        (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21 + w.w_hrs_ldc29 AS DECIMAL(30,2))))
                      - (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21sply + w.w_hrs_ldc29sply AS DECIMAL(30,2))))
                    )
                    /
                    (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc21sply + w.w_hrs_ldc29sply AS DECIMAL(30,2))))
            END
    END AS oei2sply,

    CASE
        WHEN SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_hrs_ldc22sply AS DECIMAL(30,2))) = 0
          OR SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2))) = 0
        THEN 0
        ELSE
            CASE
                WHEN (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc22sply AS DECIMAL(30,2)))) = 0
                  OR (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2)))) = 0
                THEN 0
                ELSE
                    (
                        (SUM(CAST(w.w_cty_cupd AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc22 AS DECIMAL(30,2))))
                      - (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc22sply AS DECIMAL(30,2))))
                    )
                    /
                    (SUM(CAST(w.w_sply_dels AS DECIMAL(30,2))) / SUM(CAST(w.w_hrs_ldc22sply AS DECIMAL(30,2))))
            END
    END AS sei2sply,

    (SUM(calc.cd_ern_f2b_hrs_tot) / SUM(w.w_del_days)) / 8.0 AS cd_ern_routes,
    SUM(w.w_cty_rte) / NULLIF(COUNT(w.w_wk), 0)          AS w_cty_rte,
    SUM(tc.TotWebCoinsCarriers) / NULLIF(COUNT(w.w_wk), 0) AS TotWebCoinsCarriers

FROM dbo.var_base b WITH (NOLOCK)
JOIN dbo.var_weekly w WITH (NOLOCK)
    ON b.b_fin_nbr = w.w_fin_nbr
JOIN dbo.var_calc_cdv calc WITH (NOLOCK)
    ON b.b_fin_nbr = calc.calc_fin_nbr
   AND w.w_fy      = calc.calc_fy
   AND w.w_wk      = calc.calc_wk
JOIN dbo.vw_TotalCarriers tc
    ON b.b_fin_nbr = tc.c_fin_nbr
CROSS JOIN [DSN2_DB].dbo.avar_cdv_prod prod WITH (NOLOCK)
CROSS JOIN dbo.var_annual ann WITH (NOLOCK)

WHERE
    b.b_cdv_ind = 1
    AND b.b_mpoo <> 'X'
    AND ((w.w_fy * 100) + w.w_wk) BETWEEN @begFYWk AND @endFYWk

GROUP BY
    b.b_area,
    b.b_area_name,
    prod.prod_fters_fact,
    ann.ann_del_days

ORDER BY
    dly_tot_opp DESC;










<!--- If not from the select page or mothership app then redirect --->
<cfif !IsDefined("FORM.rpt_type") && !IsDefined("URL.scope")>
    <cflocation url="avar_select.cfm" addtoken="false" />
</cfif>
<cfsetting requestTimeOut = "600" />
<cfset thisApp = "cdv" />
<CF_TrackerII PID=4>
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="title" content="USPS - Variance Programs" />
<meta name="author" content="Field Operations Support" />
<meta http-equiv="Cache-Control" content="no-cache" />
<meta http-equiv="Cache-Control" content="no-store" />
<meta http-equiv="Pragma" content="no-cache" />
<meta name="expires" content="-1" />
<title>CDV Executive Summary</title>
<script src="/scripts/tablesort.js"></script>
<cfoutput>
<link rel=stylesheet type="text/css" href="/css/avar_tablesort_v2.css?ts=#DateFormat(Now(),'yyyymmdd')##TimeFormat(Now(), 'hhmmssL')#" />
</cfoutput>
<style>
table {
    border-collapse: collapse;
    border: 1px solid #ccc;
}

td {
    border: 1px solid #ccc;
    padding-left: 3px;
    padding-right: 3px;
}

label {
    cursor: help;
}

#retainer {
    width: 95%;
    margin-right: auto;
    margin-left: auto;
}
</style>
</head>
<body>
    <cftry>
<div id="retainer">

<cfparam name="scope"         default="" />
<cfparam name="beginPeriod"   default="" />
<cfparam name="endPeriod"     default="" />
<cfparam name="sqlWhere"      default="" />
<cfparam name="reportingName" default="" />
<cfparam name="requestType"   default="URL" />

<cfset requestArgs  = StructNew() />
<cfset thisTemplate = ListLast(CGI.SCRIPT_NAME, "/") />

<!--- Determine if request is from select (FORM) or mothership (URL) --->
<Cfif IsDefined("FORM.rpt_type") && (FORM.rpt_type EQ "canned" || FORM.rpt_type EQ "adHoc")>
    <cfset requestType = "FORM" />
    <cfset requestArgs = FORM />
    <cfif requestArgs.rpt_type EQ "canned"> <!--- belt/suspenders force to numeric --->
        <cfset beginPeriod = (Left(requestArgs.canned_range, 6) * 1) />
        <cfset endPeriod   = (Right(requestArgs.canned_range, 6) * 1) />
    <cfelse> <!--- belt/suspenders force to numeric --->
        <cfset beginPeriod = requestArgs.beg_period * 1 />
        <cfset endPeriod   = requestArgs.end_period * 1 />
    </cfif>
<cfelse> <!--- URL scope --->
    <cfset requestArgs = URL />
    <cfset beginPeriod = requestArgs.beginPeriod />
    <cfset endPeriod = requestArgs.endPeriod />
</cfif>

<!--- In case the user selects a backwards in time range --->
<cfset tmpSwap = 0 />
<cfif beginPeriod GT endPeriod>
    <cfset tmpSwap     = endPeriod />
    <cfset endPeriod   = beginPeriod />
    <cfset beginPeriod = tmpSwap />
</cfif>

<cfset objCDV        = New avar_cdv() />
<cfset scopeData     = objCDV.getSummaryScopeData(requestArgs, requestType) />
<cfset begEndDates   = objCDV.getBegEndDates(beginPeriod, endPeriod) />
<cfset nbrWeeks      = objCDV.getWeeksCount(beginPeriod, endPeriod) />
<cfset scope         = scopeData.scope />
<cfset thisArea      = scopeData.area />
<cfset thisCluster   = scopeData.cluster />
<cfset thisMPOO      = scopeData.mpoo />
<cfset thisUnit      = scopeData.unit />
<cfset reportingName = scopeData.reportDescription />
<cfset begDate       = begEndDates.begin_date />
<cfset endDate       = begEndDates.end_date />
<cfset delDays       = objCDV.getDelDays(beginPeriod, endPeriod) />

<!--- For the data query --->
<cfswitch expression="#scope#">
    <cfcase value="unit">
        <cfset sqlWhere = "b_lead_fin_nbr = '#thisUnit#'" />
    </cfcase>
    <cfcase value="mpoo">
        <cfset sqlWhere = "b_cluster = '#thisCluster#' AND b_mpoo = '#thisMPOO#'" />
    </cfcase>
    <cfcase value="cluster">
        <cfset sqlWhere = "b_cluster = '#thisCluster#'" />
    </cfcase>
    <cfcase value="area">
        <cfset sqlWhere = "b_area = '#thisArea#'" />
    </cfcase>
    <cfcase value="nata">
        <cfset reportingName = "National Areas" />
    </cfcase>
    <cfdefaultcase>
        <cfset reportingName = "National Clusters" />
    </cfdefaultcase>
</cfswitch>

<!--- Pull the Data --->
<cfif scope EQ "nata">
    <cfset Formula = objCDV.formulaArea(beginPeriod, endPeriod) />
<cfelseif scope EQ "natc">
    <cfset Formula = objCDV.formulaCluster(beginPeriod, endPeriod) />
<cfelse>
    <cfset Formula = objCDV.formula(beginPeriod, endPeriod, sqlWhere) />
</cfif>

<!--- Build the URL base string --->
<cfset urlParms = "?scope=#scope#&beginPeriod=#beginPeriod#&endPeriod=#endPeriod#" />
<cfif thisArea NEQ "">
    <cfset urlParms &= "&area=#thisArea#" />
</cfif>
<cfif thisCluster NEQ "">
    <cfset urlParms &= "&cluster=#thisCluster#" />
</cfif>
<cfif thisMPOO NEQ "">
    <cfset urlParms &= "&mpoo=#thisMPOO#" />
</cfif>
<cfset exportParms = urlParms /> <!--- Don't add Unit to page records parms; will double it up --->
<cfif scope EQ "unit"> <!--- need this for export if unit level --->
    <cfset exportParms &= "&unit=#thisUnit#" />
</cfif>

<cfquery name="PCTS" datasource="#APPLICATION.dsn#">
        SELECT top 1 CAST(b_prod_dps_pct*100 AS DECIMAL(9,0)) dpsPCT, CAST(b_prod_fss_pct*100 AS DECIMAL(9,0)) fssPCT,
            pctSTND=(SELECT CAST(prod_pct_standard*100 AS DECIMAL(9,0)) FROM #APPLICATION.dsn2#.dbo.avar_cdv_prod WITH(NOLOCK))
        FROM #APPLICATION.dsn#.dbo.var_base WITH(NOLOCK)
        ORDER BY b_prod_dps_pct DESC
    </cfquery>

    <!--- Format Data --->
    <cfset totOfc = 0 />
    <cfset totStr = 0 />
    <cfset totOth = 0 />
    <cfset totOpp = 0 />
    <cfset totfters = 0 />
    <cfoutput query = "formula">
        <cfset totOfc   += dly_ofc_opp />
        <cfset totStr   += dly_str_opp />
        <cfset totOth   += dly_oth_opp />
        <cfset totOpp   += dly_tot_opp />
        <cfset totfters += dly_fters_opp />
    </cfoutput>


    <!--- ******************************************************************************************* --->
    <!---                                      Display Summary                                        --->
    <!--- ******************************************************************************************* --->

<table width="100%" border="1" cellpadding="0" cellspacing="0" align="center">
    <tr>
    <td bgcolor="003366" height="25" align="center" colspan="5">
    <font face="verdana,arial,helvetica" color="#ffffff" size="2"><b>
    <cfoutput>
        City Delivery Variance Summary <br />
        #reportingName#&nbsp;&nbsp;
        #delDays# Customer Service Days&nbsp;&nbsp;
        #begDate#&nbsp;to&nbsp;#endDate#
    </b></font></td>
    </tr>
    <tr bgcolor="003366">
        <td width="23%" align="center" bgcolor="#iif(totfters GT 0, DE('FF0000'), DE('33CC00'))#"><font face="Verdana" size="2" color="FFFFFF"><b>&nbsp;
           CDPOM:&nbsp;#NumberFormat(totfters, "9,999.0")#</b></font></td>
         <td width="18%" align="center">
            <font face="Verdana" size="2" color="FFFFFF"><b>&nbsp;
           Office Opp:&nbsp;#NumberFormat(totOfc, "9,999.0")#</b></font></td>
         <td width="18%" align="center"><font face="Verdana" size="2" color="FFFFFF"><b>&nbsp;
           Street Opp:&nbsp;#NumberFormat(totStr, "9,999.0")#</b></font></td>
         <td width="18%" align="center"><font face="Verdana" size="2" color="FFFFFF"><b>&nbsp;
           Other Opp:&nbsp;#NumberFormat(totOth, "9,999.0")#</b></font></td>
          <td width="23%" align="center" bgcolor="#iif(totOpp GT 0, DE('FF0000'), DE('33CC00'))#"><font face="Verdana" size="2" color="FFFFFF"><b>&nbsp;
           FTER Opportunity:&nbsp;#NumberFormat(totOpp, "9,999.0")#</b></font></td>
    </tr>
    <cfif Formula.RecordCount GT 25>
    <tr>
        <td height="22" bgcolor="##cccccc" valign="bottom" align="center" colspan="14" style="vertical-align: bottom;">
            <a href="avar_select.cfm" title="Return to Variance Selection Page"><img src="/images/avar_return.gif" width="94" height="15" border="0" alt=""></a>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <a href="avar_#thisApp#_exec2xl.cfm#exportParms#" title="Download City Delivery Variance Summary to Excel"><img src="/images/avar_send2excel.gif" width="80" height="15" alt="Download City Delivery Variance Summary to Excel" border="0"></a>
        </td>
    </tr>
    </cfif>
    </cfoutput>
    <tr>
    </table>
    <table cellpadding="0" width="100%" cellspacing="0" class="generique style-alternative" style="font-size:11px">
        <cfoutput>
        <thead>
        <tr>
        <th class="sortable" align="center" width="250" valign="bottom">Delivery Unit Name</th>
        <th class="sortable" align="center" width="100" valign="bottom">Percent to Minimum Standard Target: #PCTS.pctSTND#%</th>
        <!---
        <th class="sortable" align="center" width="100" valign="bottom">OEI Pct to SPLY</th>
        <th class="sortable" align="center" width="100" valign="bottom">SEI Pct to SPLY</th>
        --->
        <th class="sortable" align="center" width="100" valign="bottom">DPH Pct to SPLY </th>
        <th class="sortable" align="center" width="100" valign="bottom">DPS Letter Pct. Target: #PCTS.dpsPCT#%</th>
        <th class="sortable" align="center" width="100" valign="bottom">DPS Flat Pct. Target: #PCTS.fssPCT#%</th>
        <th class="sortable" align="center" width="100" valign="bottom">Cased Vol Pct.</th>
        <th class="sortable" align="center" width="100" valign="bottom">Actual CSR (Earned 1.34)</th>
        <th class="sortable" align="center" width="100" valign="bottom">Percent Overtime</th>
        <th class="sortable" align="center" width="100" valign="bottom">CDPOM Opp. Target: <=0</th>
        <th class="sortable" align="center" width="100" valign="bottom">&nbsp;&nbsp;Daily&nbsp;&nbsp; Office Opp. Target: <=0</th>
        <th class="sortable" align="center" width="100" valign="bottom">&nbsp;&nbsp;Daily&nbsp;&nbsp; Street Opp. Target: <=0</th>
        <th class="sortable" align="center" width="100" valign="bottom">&nbsp;&nbsp;Daily&nbsp;&nbsp; Other Opp. Target: <=0</th>
        <th class="sortable" align="center" width="100" valign="bottom">Daily FTER Total Opp. Target: <=0</th>
        <th class="sortable" align="center" width="100" valign="bottom">Percent Achieved</th>
        </tr>
        </thead>
        </cfoutput>
        <tbody>
        <cfoutput query="formula">
		
		
		<!-- 2024-1-24 Added new condition to hide certain data - Tim Tran -->
		<cfif (scope NEQ "nata" && scope NEQ "natc") || (find("4", #b_area#) GT 0 )>
		
            <tr>
                <td valign="bottom" nowrap style="text-align: right; padding-right: 3px;">
                    <cfif scope EQ "nata">
                        <a href="#thisTemplate#?scope=area&beginPeriod=#beginPeriod#&endPeriod=#endPeriod#&area=#b_area#&unit=nata" title="Link to Variance Report for #b_area_name#">(#b_area#) #b_area_name#</a>
                    <cfelseif scope EQ "natc">
                        <a href="#thisTemplate#?scope=cluster&beginPeriod=#beginPeriod#&endPeriod=#endPeriod#&cluster=#b_cluster#&unit=natc" title="Link to Variance Report for #b_cluster_name#">(#b_area#) #b_cluster_name#</a>
                    <cfelse>
                        <a href="avar_#thisApp#1.cfm#urlParms#&unit=#b_fin_nbr#" title="Link to #b_fin_name# Unit Variance Report">#b_fin_name#</a>
                        <cfif b_rto_ind EQ 1><span style="font-size: 9px;" title="Unit is an RTI">(RTO)</span></cfif>
                        <cfif b_fss_ind EQ 1 AND b_dps_ind EQ 1><span style="font-size: 9px;" title="Unit has Both City DPS Flats and Letters">(B)</span>
                        <cfelseif b_fss_ind EQ 1 AND b_dps_ind EQ 0><span style="font-size: 9px;" title="Unit has City DPS Flats">(F)</span>
                        <cfelseif b_fss_ind EQ 0 AND b_dps_ind EQ 1><span style="font-size: 9px;" title="Unit has City DPS Letters">(L)</span>
                        <cfelse><span style="font-size: 9px;" title="Unit has no City DPS Flats or Letters">(N)</span>
                        </cfif>
                    </cfif>
                    <!--- <cfif qryRTO.b_rto_ind EQ 1><span style="font-size: 9px;" title="Unit is an RTO Site.">&nbsp;(RTO)</span></cfif> --->
                </td>
                <cfif TotWebCoinsCarriers EQ '' || w_cty_rte EQ '' || w_cty_rte EQ 0>
                    <cfset actualCSR = 0 />
                <cfelse>
                    <cfset actualCSR = TotWebCoinsCarriers/w_cty_rte />
                </cfif>
                <td align="center" width="100">#NumberFormat(act_pct_standard*100, '9')#</td>
                <!---
                <td align="center" width="100">#decimalFormat(oei2sply*100)#</td>
                <td align="center" width="100">#decimalFormat(sei2sply*100)#</td>
                --->
                <td align="center" width="100">#decimalFormat(dph2sply*100)#</td>
                <td align="center" width="100">#NumberFormat(dps_pct*100, '9')#</td>
                <td align="center" width="100">#NumberFormat(fss_pct*100, '9')#</td>
                <td align="center" width="100">#NumberFormat(ManVolPct*100, '9')#</td>
                <td align="center" width="100">#decimalformat(actualCSR)#</td>
                <td align="center" width="100">#decimalFormat(ot_pct*100)#</td>
                <td align="center" width="100">#decimalFormat(dly_fters_opp)#</td>
                <td align="center" width="100">#decimalFormat(dly_ofc_opp)#</td>
                <td align="center" width="100">#decimalFormat(dly_str_opp)#</td>
                <td align="center" width="100">#decimalFormat(dly_oth_opp)#</td>
                <td align="center" width="100">#decimalFormat(dly_tot_opp)#</td>
                <td align="center" width="100">#decimalFormat(tot_pct_ach*100)#</td>
            </tr>
			
		</cfif>	
			
			
			
        </cfoutput>
        </tbody>
    <tr> <!--- MUST BE BELOW THE TBODY CLOSE OR IT WILL BE INCLUDED IN THE SORT RESULTS --->
        <cfoutput>
        <td height="22" bgcolor="##cccccc" valign="bottom" align="center" colspan="14" style="vertical-align: bottom;">
            <a href="avar_select.cfm" title="Return to Variance Selection Page"><img src="/images/avar_return.gif" width="94" height="15" border="0" alt=""></a>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <a href="avar_#thisApp#_exec2xl.cfm#exportParms#" title="Download City Deliver Variance Summary to Excel"><img src="/images/avar_send2excel.gif" width="80" height="15" alt="Download City Delivery Variance Summary to Excel" border="0"></a>
        </td>
        </cfoutput>
    </tr>
</table>
</div>
<cfcatch type="any">
    <cfoutput>#cfcatch.detail#</cfoutput>
</cfcatch>
</cftry>
</body>
</html>






 SELECT b_area, b_area_name,
            CASE WHEN SUM(CAST(b_sei_ldc22 AS DECIMAL(30,2)))=0 THEN 0 ELSE SUM(CAST(b_sei_del AS DECIMAL(30,2))) / SUM(CAST(b_sei_ldc22 AS DECIMAL(30,2))) END AS B_SEI_PREV_YR,

                CASE WHEN SUM(CAST(w_hrs_ldc21+w_hrs_ldc29 AS DECIMAL(30,2)))=0 OR SUM(CAST(w_vol_cas_ltr AS DECIMAL(30,2)))=0 OR SUM(CAST(w_vol_cas_flt AS DECIMAL(30,2)))=0
                THEN
                    0
                    ELSE (SUM(CAST(w_hrs_ldc21+w_hrs_ldc29 AS DECIMAL(30,2))))/ (((((SUM(CAST(w_vol_cas_ltr AS DECIMAL(30,2))) /18)+(SUM(CAST(w_vol_cas_flt AS DECIMAL(30,2)))/8)+ ((SUM(CAST(w_vol_cas_ltr AS DECIMAL(30,2)))+SUM(CAST(w_vol_cas_flt AS DECIMAL(30,2))))/70))/60)) +(sum(CAST(b_hrs_fot_w_brk * w_del_days AS DECIMAL(30,2))) ))
                END act_pct_standard,

                CASE WHEN SUM(CAST(w_hrs_ldc21 as decimal(30,2))+ CAST(w_hrs_ldc22 as decimal(30,2))+ CAST(w_hrs_ldc23 as decimal(30,2)) + CAST(w_hrs_ldc26 as decimal(30,2))+ CAST(w_hrs_ldc27 as decimal(30,2)) + CAST(w_hrs_ldc29 as decimal(30,2)))=0 THEN 0
                    ELSE (SUM(CAST(cd_ern_hrs_ldc21 AS DECIMAL(30,2))) +SUM(CAST(cd_ern_hrs_ldc22 AS DECIMAL(30,2))) +SUM(CAST(cd_ern_hrs_ldc23 AS DECIMAL(30,2))) +SUM(CAST(cd_ern_hrs_ldc26 AS DECIMAL(30,2))) +SUM(CAST(cd_ern_hrs_ldc27 AS DECIMAL(30,2))) +SUM(CAST(cd_ern_hrs_ldc29 AS DECIMAL(30,2))))/
                            SUM(CAST(w_hrs_ldc21 as decimal(30,2))+ CAST(w_hrs_ldc22 as decimal(30,2))+ CAST(w_hrs_ldc23 as decimal(30,2)) + CAST(w_hrs_ldc26 as decimal(30,2))+ CAST(w_hrs_ldc27 as decimal(30,2)) + CAST(w_hrs_ldc29 as decimal(30,2)))
                END  tot_pct_ach,

                CASE WHEN SUM(CAST(cd_ern_hrs_ldc21 AS DECIMAL(30,2)))=0 OR SUM(CAST(w_cty_cupd AS DECIMAL(30,2)))=0 OR SUM(CAST(w_hrs_ldc21 AS DECIMAL(30,2)) + CAST(w_hrs_ldc29 AS DECIMAL(30,2)))=0 THEN 0
                       ELSE (SUM(CAST(w_cty_cupd as decimal(30,2)))/SUM(CAST(w_hrs_ldc21 AS DECIMAL(30,2))+ CAST(w_hrs_ldc29 AS DECIMAL(30,2))))-(SUM(CAST(w_cty_cupd AS DECIMAL(30,2)))/SUM(CAST(w_hrs_ldc21 AS DECIMAL(30,2))+ CAST(w_hrs_ldc29 AS DECIMAL(30,2)))) END oei_var2earned,

                CASE WHEN
                    SUM(CAST(w_sply_dels as decimal(30,2))) =0 OR SUM(CAST(w_sply_hrs as decimal(30,2))) = 0 OR SUM(CAST(w_hrs_ldc21 as decimal(30,2)) + CAST(w_hrs_ldc22 as decimal(30,2)) + CAST(w_hrs_ldc23 as decimal(30,2)) + CAST(w_hrs_ldc24 as decimal(30,2)) + CAST(w_hrs_ldc26 as decimal(30,2)) + CAST(w_hrs_ldc27 as decimal(30,2)) + CAST(w_hrs_ldc28 as decimal(30,2)) + CAST(w_hrs_ldc29 as decimal(30,2)) + CAST(w_hrs_ldc92 as decimal(30,2))) = 0
                THEN
                    0
                ELSE
                    CASE WHEN
                        SUM(CAST(w_sply_dels as decimal(30,2)))/SUM(CAST(w_sply_hrs as decimal(30,2)))=0 OR SUM(CAST(w_cty_cupd as decimal(30,2)))/SUM(CAST(w_hrs_ldc21 as decimal(30,2)) + CAST(w_hrs_ldc22 as decimal(30,2)) + CAST(w_hrs_ldc23 as decimal(30,2)) + CAST(w_hrs_ldc24 as decimal(30,2)) + CAST(w_hrs_ldc26 as decimal(30,2)) + CAST(w_hrs_ldc27 as decimal(30,2)) + CAST(w_hrs_ldc28 as decimal(30,2)) + CAST(w_hrs_ldc29 as decimal(30,2)) + CAST(w_hrs_ldc92 as decimal(30,2))) =0
                    THEN
                        0
                    ELSE
                        ((SUM(CAST(w_cty_cupd as decimal(30,2)))/SUM(CAST(w_hrs_ldc21 as decimal(30,2)) + CAST(w_hrs_ldc22 as decimal(30,2)) + CAST(w_hrs_ldc23 as decimal(30,2)) + CAST(w_hrs_ldc24 as decimal(30,2)) +CAST(w_hrs_ldc26 as decimal(30,2)) + CAST(w_hrs_ldc27 as decimal(30,2)) + CAST(w_hrs_ldc28 as decimal(30,2)) + CAST(w_hrs_ldc29 as decimal(30,2)) + CAST(w_hrs_ldc92 as decimal(30,2))))
                            - (SUM(CAST(w_sply_dels as decimal(30,2)))/SUM(CAST(w_sply_hrs as decimal(30,2)))))
                        /(SUM(CAST(w_sply_dels as decimal(30,2)))/SUM(CAST(w_sply_hrs as decimal(30,2))))
                    END
                END dph2sply,

                CASE WHEN SUM(CAST(w_vol_dps_ltr as decimal(30,2)))=0 THEN 0 ELSE (SUM(CAST(w_vol_dps_ltr as decimal(30,2)))/SUM(CAST(w_vol_cas_ltr+w_vol_dps_ltr as decimal(30,2)))) END dps_pct,

                CASE WHEN SUM(CAST(w_vol_dps_flt as decimal(30,2)))=0 THEN 0 ELSE (SUM(CAST(w_vol_dps_flt as decimal(30,2)))/SUM(CAST(w_vol_cas_flt+w_vol_dps_flt as decimal(30,2)))) END fss_pct,

                CASE WHEN SUM(CAST(w_vol_dps_ltr+ w_vol_dps_flt + w_vol_cas_flt + w_vol_cas_ltr AS BIGINT)) =0
                THEN 0
                ELSE
                    SUM(CAST(w_vol_cas_flt + w_vol_cas_ltr AS BIGINT)) /SUM(CAST(w_vol_dps_ltr+ w_vol_dps_flt + w_vol_cas_flt + w_vol_cas_ltr AS DECIMAL(30,4)))
                END ManVolPct,

                CASE WHEN SUM(CAST(w_hrs_car_ot AS DECIMAL(30,4)))=0 OR SUM(CAST(w_hrs_car_tot AS DECIMAL(30,4)))=0 THEN 0 ELSE (SUM(CAST(w_hrs_car_ot AS DECIMAL(30,4)))/(SUM(CAST(w_hrs_car_tot AS DECIMAL(30,4))))) END ot_pct,

                CASE WHEN SUM(CAST(cd_ern_hrs_ldc21 as decimal(30,2)) + cast(cd_ern_hrs_ldc22 as decimal(30,2)) +cast(cd_ern_hrs_ldc26 as decimal(30,2))) =0 OR SUM(CAST(b_collection_unit_ind as tinyint))=1 THEN 0
                ELSE
                    (((((SUM(cast(dbo.var_base.b_hrs_ldc21*w_del_days as decimal(30,8))+
                    cast(dbo.var_base.b_hrs_ldc22*w_del_days as decimal(30,8)) +
                    cast(dbo.var_base.b_hrs_ldc29*w_del_days as decimal(30,8)))
                    +(SUM(cast(dbo.var_base.b_car_rte_nbr*w_del_days as decimal(30,8)))*4/
                    cast(dbo.var_annual.ann_del_days as decimal(30,8)))))-
                    SUM(cast(cd_ern_hrs_ldc21 as decimal(30,8))+
                    cast(cd_ern_hrs_ldc22 as decimal(30,8))+
                    cast(cd_ern_hrs_ldc26 as decimal(30,8)))*
                    cast(prod_fters_fact as decimal(30,8)))
                    /8)/sum(w_del_days))
                END dly_fters_opp,

                CASE WHEN SUM(CAST(w_hrs_ldc21 as decimal(30,2)) + CAST(w_hrs_ldc26 as decimal(30,2)) + CAST(w_hrs_ldc29 as decimal(30,2)))=0 THEN 0 ELSE ((((SUM(CAST(w_hrs_ldc21 as decimal(30,2)) + CAST(w_hrs_ldc26 as decimal(30,2)) + CAST(w_hrs_ldc29 as decimal(30,2))))-(SUM(CAST(cd_ern_hrs_ldc21 as decimal(30,2)) + CAST(cd_ern_hrs_ldc26 as decimal(30,2)))))/sum(w_del_days))/8) END dly_ofc_opp,

                CASE WHEN SUM(cast(w_hrs_ldc22 as decimal(30,2)) + cast(cd_ern_hrs_ldc22 as decimal(30,2)))=0 THEN 0 ELSE (((SUM(cast(w_hrs_ldc22 as decimal(30,2)))-SUM(cast(cd_ern_hrs_ldc22 as decimal(30,2))))/sum(w_del_days))/8) END dly_str_opp,

                CASE WHEN SUM(cast(w_hrs_ldc23 as decimal(30,2)) + cast(w_hrs_ldc27 as decimal(30,2)) + cast(cd_ern_hrs_ldc23 as decimal(30,2)) +cast(cd_ern_hrs_ldc27 as decimal(30,2)))=0 THEN 0 ELSE (((SUM(cast(w_hrs_ldc23 as decimal(30,2))+cast(w_hrs_ldc27 as decimal(30,2)))-((ISNULL(SUM(cast(cd_ern_hrs_ldc23 as decimal(30,2))+cast(cd_ern_hrs_ldc27 as decimal(30,2))),0))))/sum(w_del_days))/8) END dly_oth_opp,

                CASE WHEN SUM(cast(w_hrs_ldc21 as decimal(30,2)) + cast(w_hrs_ldc26 as decimal(30,2)) + cast(w_hrs_ldc29 as decimal(30,2)) + cast(w_hrs_ldc23 as decimal(30,2)) + cast(w_hrs_ldc27 as decimal(30,2)))=0 THEN 0 ELSE ((((SUM(cast(w_hrs_ldc21 as decimal(30,2)) + cast(w_hrs_ldc26 as decimal(30,2)) + cast(w_hrs_ldc29 as decimal(30,2))))-(SUM(cast(cd_ern_hrs_ldc21 as decimal(30,2)) + cast(cd_ern_hrs_ldc26 as decimal(30,2)))))/sum(w_del_days))/8)+ (((SUM(cast(w_hrs_ldc22 as decimal(30,2)))-SUM(cast(cd_ern_hrs_ldc22 as decimal(30,2))))/sum(w_del_days))/8)+ (((SUM(cast(w_hrs_ldc23 as decimal(30,2))+cast(w_hrs_ldc27 as decimal(30,2)))-((ISNULL(SUM(cast(cd_ern_hrs_ldc23 as decimal(30,2))+cast(cd_ern_hrs_ldc27 as decimal(30,2))),0))))/sum(w_del_days))/8) END dly_tot_opp,

                CASE WHEN SUM(cast(w_cty_cupd as decimal(30,2)))=0 OR SUM(cast(w_hrs_ldc21 as decimal(30,2)) + cast(w_hrs_ldc29 as decimal(30,2)))=0 THEN 0 ELSE SUM(cast(w_cty_cupd as decimal(30,2)))/SUM(cast(w_hrs_ldc21 as decimal(30,2)) + cast(w_hrs_ldc29 as decimal(30,2))) END aoei,

                   CASE WHEN SUM(CAST(w_cty_cupd AS DECIMAL(30,2)))=0 OR SUM(CAST(w_hrs_ldc22 AS DECIMAL(30,2)))=0 THEN 0 ELSE (SUM(CAST(w_cty_cupd AS DECIMAL(30,4)))/SUM(CAST(w_hrs_ldc22 AS DECIMAL(30,2)))) END asei,

                CASE WHEN SUM(cast(w_sply_dels AS DECIMAL(30,2)))=0 OR SUM(cast(w_hrs_ldc21sply AS DECIMAL(30,2)) +cast(w_hrs_ldc29sply AS DECIMAL(30,2)))=0 OR SUM(cast(w_hrs_ldc21 AS DECIMAL(30,2)) + cast(w_hrs_ldc29 AS DECIMAL(30,2)))=0 THEN 0 ELSE CASE WHEN SUM(cast(w_sply_dels AS DECIMAL(30,2)))/SUM(cast(w_hrs_ldc21sply AS DECIMAL(30,2)) + cast(w_hrs_ldc29sply AS DECIMAL(30,2)))=0 OR SUM(cast(w_cty_cupd AS DECIMAL(30,2)))/SUM(cast(w_hrs_ldc21 AS DECIMAL(30,2)) + cast(w_hrs_ldc29 AS DECIMAL(30,2)))=0 THEN 0 ELSE ((SUM(cast(w_cty_cupd AS DECIMAL(30,2)))/SUM(cast(w_hrs_ldc21 AS DECIMAL(30,2)) + cast(w_hrs_ldc29 AS DECIMAL(30,2))))-(SUM(cast(w_sply_dels AS DECIMAL(30,2)))/SUM(cast(w_hrs_ldc21sply AS DECIMAL(30,2)) + cast(w_hrs_ldc29sply AS DECIMAL(30,2)))))/(SUM(cast(w_sply_dels AS DECIMAL(30,2)))/SUM(cast(w_hrs_ldc21sply AS DECIMAL(30,2)) + cast(w_hrs_ldc29sply AS DECIMAL(30,2)))) END END oei2sply,

                CASE WHEN SUM(cast(w_sply_dels AS DECIMAL(30,2)))=0 OR SUM(cast(w_hrs_ldc22sply AS DECIMAL(30,2)))=0 OR SUM(cast(w_hrs_ldc22 AS DECIMAL(30,2)))=0 THEN 0 ELSE CASE WHEN SUM(cast(w_sply_dels AS DECIMAL(30,2)))/SUM(cast(w_hrs_ldc22sply AS DECIMAL(30,2)))=0 OR SUM(cast(w_cty_cupd AS DECIMAL(30,2)))/SUM(cast(w_hrs_ldc22 AS DECIMAL(30,2)))=0 THEN 0 ELSE ((SUM(cast(w_cty_cupd AS DECIMAL(30,2)))/SUM(cast(w_hrs_ldc22 AS DECIMAL(30,2))))-(SUM(cast(w_sply_dels AS DECIMAL(30,2))) / SUM(cast(w_hrs_ldc22sply AS DECIMAL(30,2)))))/(SUM(cast(w_sply_dels AS DECIMAL(30,2))) / SUM(cast(w_hrs_ldc22sply AS DECIMAL(30,2)))) END END sei2sply,

                (SUM(cd_ern_f2b_hrs_tot)/sum(w_del_days))/8 cd_ern_routes,
                SUM(w_cty_rte)/COUNT(w_wk) w_cty_rte,
                SUM(TotWebCoinsCarriers)/COUNT(w_wk)  TotWebCoinsCarriers

            FROM var_base WITH(NOLOCK),var_weekly WITH(NOLOCK),var_calc_cdv WITH(NOLOCK),
                #APPLICATION.dsn2#.dbo.avar_cdv_prod WITH(NOLOCK),var_annual with(nolock),vw_TotalCarriers
            WHERE b_fin_nbr=w_fin_nbr
                 AND b_fin_nbr=calc_fin_nbr
                 AND b_fin_nbr=c_fin_nbr
                 AND w_fy=calc_fy
                 AND w_wk=calc_wk AND b_cdv_ind=1 AND b_mpoo<>'X'
                 AND ((w_fy * 100) + w_wk) BETWEEN #ARGUMENTS.begFYWk# AND #ARGUMENTS.endFYWk#
            GROUP BY b_area, b_area_name, prod_fters_fact, ann_del_days
            ORDER BY dly_tot_opp desc
