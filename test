WITH base_data AS (
    SELECT
          b.b_area_name,
          b.b_cluster_name,
          b.b_lead_fin_nbr,
          b.b_lead_name,
          b.b_fin_nbr,
          b.b_fin_name,
          b.b_mpoo,
          b.b_pce_ind,
          w.w_fy,

          -- Delivered Volume (letters + flats + DPS + sequenced)
          CAST(w.w_vol_cas_ltr AS BIGINT)
        + CAST(w.w_vol_cas_flt AS BIGINT)
        + CAST(w.w_vol_dps_ltr AS BIGINT)
        + CAST(w.w_vol_dps_flt AS BIGINT)
        + CAST(w.w_vol_seq_pcs AS BIGINT) AS delivered_volume,

          -- PKCC
          CAST(w.w_vol_pkcc AS BIGINT) AS pkcc_volume

    FROM [PCDV_DW].[dbo].[var_weekly] w
    JOIN [PCDV_DW].[dbo].[var_base] b
          ON w.w_fin_nbr = b.b_fin_nbr
    WHERE 
          b.b_level >= 21
          AND b.b_cdv_ind = 1
		  and b_mpoo <> 'Z'
          AND w.w_fy BETWEEN 2021 AND 2025
)

SELECT
      b_area_name,
      b_cluster_name,
      b_lead_fin_nbr,
      b_lead_name,
      b_fin_nbr,
      b_fin_name,
      b_mpoo,
      b_pce_ind,

      -- Delivered Volume by FY
      SUM(CASE WHEN w_fy = 2021 THEN delivered_volume END) AS Delivered_2021,
      SUM(CASE WHEN w_fy = 2022 THEN delivered_volume END) AS Delivered_2022,
      SUM(CASE WHEN w_fy = 2023 THEN delivered_volume END) AS Delivered_2023,
      SUM(CASE WHEN w_fy = 2024 THEN delivered_volume END) AS Delivered_2024,
      SUM(CASE WHEN w_fy = 2025 THEN delivered_volume END) AS Delivered_2025,

      -- PKCC by FY
      SUM(CASE WHEN w_fy = 2021 THEN pkcc_volume END) AS PKCC_2021,
      SUM(CASE WHEN w_fy = 2022 THEN pkcc_volume END) AS PKCC_2022,
      SUM(CASE WHEN w_fy = 2023 THEN pkcc_volume END) AS PKCC_2023,
      SUM(CASE WHEN w_fy = 2024 THEN pkcc_volume END) AS PKCC_2024,
      SUM(CASE WHEN w_fy = 2025 THEN pkcc_volume END) AS PKCC_2025

FROM base_data
GROUP BY
      b_area_name,
      b_cluster_name,
      b_lead_fin_nbr,
      b_lead_name,
      b_fin_nbr,
      b_fin_name,
      b_mpoo,
      b_pce_ind

ORDER BY
      b_area_name,
      b_cluster_name,
      b_fin_nbr;










<!--- If not from the select page or mothership app then redirect --->
<cfif !IsDefined("FORM.rpt_type") && !IsDefined("URL.scope")>
    <cflocation url="avar_select.cfm" addtoken="false" />
</cfif>
<cfsetting requestTimeOut = "600" />
<cfset thisApp = "cdv" />
<CF_TrackerII PID=4>
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="title" content="USPS - Variance Programs" />
<meta name="author" content="Field Operations Support" />
<meta http-equiv="Cache-Control" content="no-cache" />
<meta http-equiv="Cache-Control" content="no-store" />
<meta http-equiv="Pragma" content="no-cache" />
<meta name="expires" content="-1" />
<title>CDV Executive Summary</title>
<script src="/scripts/tablesort.js"></script>
<cfoutput>
<link rel=stylesheet type="text/css" href="/css/avar_tablesort_v2.css?ts=#DateFormat(Now(),'yyyymmdd')##TimeFormat(Now(), 'hhmmssL')#" />
</cfoutput>
<style>
table {
    border-collapse: collapse;
    border: 1px solid #ccc;
}

td {
    border: 1px solid #ccc;
    padding-left: 3px;
    padding-right: 3px;
}

label {
    cursor: help;
}

#retainer {
    width: 95%;
    margin-right: auto;
    margin-left: auto;
}
</style>
</head>
<body>
    <cftry>
<div id="retainer">

<cfparam name="scope"         default="" />
<cfparam name="beginPeriod"   default="" />
<cfparam name="endPeriod"     default="" />
<cfparam name="sqlWhere"      default="" />
<cfparam name="reportingName" default="" />
<cfparam name="requestType"   default="URL" />

<cfset requestArgs  = StructNew() />
<cfset thisTemplate = ListLast(CGI.SCRIPT_NAME, "/") />

<!--- Determine if request is from select (FORM) or mothership (URL) --->
<Cfif IsDefined("FORM.rpt_type") && (FORM.rpt_type EQ "canned" || FORM.rpt_type EQ "adHoc")>
    <cfset requestType = "FORM" />
    <cfset requestArgs = FORM />
    <cfif requestArgs.rpt_type EQ "canned"> <!--- belt/suspenders force to numeric --->
        <cfset beginPeriod = (Left(requestArgs.canned_range, 6) * 1) />
        <cfset endPeriod   = (Right(requestArgs.canned_range, 6) * 1) />
    <cfelse> <!--- belt/suspenders force to numeric --->
        <cfset beginPeriod = requestArgs.beg_period * 1 />
        <cfset endPeriod   = requestArgs.end_period * 1 />
    </cfif>
<cfelse> <!--- URL scope --->
    <cfset requestArgs = URL />
    <cfset beginPeriod = requestArgs.beginPeriod />
    <cfset endPeriod = requestArgs.endPeriod />
</cfif>

<!--- In case the user selects a backwards in time range --->
<cfset tmpSwap = 0 />
<cfif beginPeriod GT endPeriod>
    <cfset tmpSwap     = endPeriod />
    <cfset endPeriod   = beginPeriod />
    <cfset beginPeriod = tmpSwap />
</cfif>

<cfset objCDV        = New avar_cdv() />
<cfset scopeData     = objCDV.getSummaryScopeData(requestArgs, requestType) />
<cfset begEndDates   = objCDV.getBegEndDates(beginPeriod, endPeriod) />
<cfset nbrWeeks      = objCDV.getWeeksCount(beginPeriod, endPeriod) />
<cfset scope         = scopeData.scope />
<cfset thisArea      = scopeData.area />
<cfset thisCluster   = scopeData.cluster />
<cfset thisMPOO      = scopeData.mpoo />
<cfset thisUnit      = scopeData.unit />
<cfset reportingName = scopeData.reportDescription />
<cfset begDate       = begEndDates.begin_date />
<cfset endDate       = begEndDates.end_date />
<cfset delDays       = objCDV.getDelDays(beginPeriod, endPeriod) />

<!--- For the data query --->
<cfswitch expression="#scope#">
    <cfcase value="unit">
        <cfset sqlWhere = "b_lead_fin_nbr = '#thisUnit#'" />
    </cfcase>
    <cfcase value="mpoo">
        <cfset sqlWhere = "b_cluster = '#thisCluster#' AND b_mpoo = '#thisMPOO#'" />
    </cfcase>
    <cfcase value="cluster">
        <cfset sqlWhere = "b_cluster = '#thisCluster#'" />
    </cfcase>
    <cfcase value="area">
        <cfset sqlWhere = "b_area = '#thisArea#'" />
    </cfcase>
    <cfcase value="nata">
        <cfset reportingName = "National Areas" />
    </cfcase>
    <cfdefaultcase>
        <cfset reportingName = "National Clusters" />
    </cfdefaultcase>
</cfswitch>

<!--- Pull the Data --->
<cfif scope EQ "nata">
    <cfset Formula = objCDV.formulaArea(beginPeriod, endPeriod) />
<cfelseif scope EQ "natc">
    <cfset Formula = objCDV.formulaCluster(beginPeriod, endPeriod) />
<cfelse>
    <cfset Formula = objCDV.formula(beginPeriod, endPeriod, sqlWhere) />
</cfif>

<!--- Build the URL base string --->
<cfset urlParms = "?scope=#scope#&beginPeriod=#beginPeriod#&endPeriod=#endPeriod#" />
<cfif thisArea NEQ "">
    <cfset urlParms &= "&area=#thisArea#" />
</cfif>
<cfif thisCluster NEQ "">
    <cfset urlParms &= "&cluster=#thisCluster#" />
</cfif>
<cfif thisMPOO NEQ "">
    <cfset urlParms &= "&mpoo=#thisMPOO#" />
</cfif>
<cfset exportParms = urlParms /> <!--- Don't add Unit to page records parms; will double it up --->
<cfif scope EQ "unit"> <!--- need this for export if unit level --->
    <cfset exportParms &= "&unit=#thisUnit#" />
</cfif>

<cfquery name="PCTS" datasource="#APPLICATION.dsn#">
        SELECT top 1 CAST(b_prod_dps_pct*100 AS DECIMAL(9,0)) dpsPCT, CAST(b_prod_fss_pct*100 AS DECIMAL(9,0)) fssPCT,
            pctSTND=(SELECT CAST(prod_pct_standard*100 AS DECIMAL(9,0)) FROM #APPLICATION.dsn2#.dbo.avar_cdv_prod WITH(NOLOCK))
        FROM #APPLICATION.dsn#.dbo.var_base WITH(NOLOCK)
        ORDER BY b_prod_dps_pct DESC
    </cfquery>

    <!--- Format Data --->
    <cfset totOfc = 0 />
    <cfset totStr = 0 />
    <cfset totOth = 0 />
    <cfset totOpp = 0 />
    <cfset totfters = 0 />
    <cfoutput query = "formula">
        <cfset totOfc   += dly_ofc_opp />
        <cfset totStr   += dly_str_opp />
        <cfset totOth   += dly_oth_opp />
        <cfset totOpp   += dly_tot_opp />
        <cfset totfters += dly_fters_opp />
    </cfoutput>


    <!--- ******************************************************************************************* --->
    <!---                                      Display Summary                                        --->
    <!--- ******************************************************************************************* --->

<table width="100%" border="1" cellpadding="0" cellspacing="0" align="center">
    <tr>
    <td bgcolor="003366" height="25" align="center" colspan="5">
    <font face="verdana,arial,helvetica" color="#ffffff" size="2"><b>
    <cfoutput>
        City Delivery Variance Summary <br />
        #reportingName#&nbsp;&nbsp;
        #delDays# Customer Service Days&nbsp;&nbsp;
        #begDate#&nbsp;to&nbsp;#endDate#
    </b></font></td>
    </tr>
    <tr bgcolor="003366">
        <td width="23%" align="center" bgcolor="#iif(totfters GT 0, DE('FF0000'), DE('33CC00'))#"><font face="Verdana" size="2" color="FFFFFF"><b>&nbsp;
           CDPOM:&nbsp;#NumberFormat(totfters, "9,999.0")#</b></font></td>
         <td width="18%" align="center">
            <font face="Verdana" size="2" color="FFFFFF"><b>&nbsp;
           Office Opp:&nbsp;#NumberFormat(totOfc, "9,999.0")#</b></font></td>
         <td width="18%" align="center"><font face="Verdana" size="2" color="FFFFFF"><b>&nbsp;
           Street Opp:&nbsp;#NumberFormat(totStr, "9,999.0")#</b></font></td>
         <td width="18%" align="center"><font face="Verdana" size="2" color="FFFFFF"><b>&nbsp;
           Other Opp:&nbsp;#NumberFormat(totOth, "9,999.0")#</b></font></td>
          <td width="23%" align="center" bgcolor="#iif(totOpp GT 0, DE('FF0000'), DE('33CC00'))#"><font face="Verdana" size="2" color="FFFFFF"><b>&nbsp;
           FTER Opportunity:&nbsp;#NumberFormat(totOpp, "9,999.0")#</b></font></td>
    </tr>
    <cfif Formula.RecordCount GT 25>
    <tr>
        <td height="22" bgcolor="##cccccc" valign="bottom" align="center" colspan="14" style="vertical-align: bottom;">
            <a href="avar_select.cfm" title="Return to Variance Selection Page"><img src="/images/avar_return.gif" width="94" height="15" border="0" alt=""></a>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <a href="avar_#thisApp#_exec2xl.cfm#exportParms#" title="Download City Delivery Variance Summary to Excel"><img src="/images/avar_send2excel.gif" width="80" height="15" alt="Download City Delivery Variance Summary to Excel" border="0"></a>
        </td>
    </tr>
    </cfif>
    </cfoutput>
    <tr>
    </table>
    <table cellpadding="0" width="100%" cellspacing="0" class="generique style-alternative" style="font-size:11px">
        <cfoutput>
        <thead>
        <tr>
        <th class="sortable" align="center" width="250" valign="bottom">Delivery Unit Name</th>
        <th class="sortable" align="center" width="100" valign="bottom">Percent to Minimum Standard Target: #PCTS.pctSTND#%</th>
        <!---
        <th class="sortable" align="center" width="100" valign="bottom">OEI Pct to SPLY</th>
        <th class="sortable" align="center" width="100" valign="bottom">SEI Pct to SPLY</th>
        --->
        <th class="sortable" align="center" width="100" valign="bottom">DPH Pct to SPLY </th>
        <th class="sortable" align="center" width="100" valign="bottom">DPS Letter Pct. Target: #PCTS.dpsPCT#%</th>
        <th class="sortable" align="center" width="100" valign="bottom">DPS Flat Pct. Target: #PCTS.fssPCT#%</th>
        <th class="sortable" align="center" width="100" valign="bottom">Cased Vol Pct.</th>
        <th class="sortable" align="center" width="100" valign="bottom">Actual CSR (Earned 1.34)</th>
        <th class="sortable" align="center" width="100" valign="bottom">Percent Overtime</th>
        <th class="sortable" align="center" width="100" valign="bottom">CDPOM Opp. Target: <=0</th>
        <th class="sortable" align="center" width="100" valign="bottom">&nbsp;&nbsp;Daily&nbsp;&nbsp; Office Opp. Target: <=0</th>
        <th class="sortable" align="center" width="100" valign="bottom">&nbsp;&nbsp;Daily&nbsp;&nbsp; Street Opp. Target: <=0</th>
        <th class="sortable" align="center" width="100" valign="bottom">&nbsp;&nbsp;Daily&nbsp;&nbsp; Other Opp. Target: <=0</th>
        <th class="sortable" align="center" width="100" valign="bottom">Daily FTER Total Opp. Target: <=0</th>
        <th class="sortable" align="center" width="100" valign="bottom">Percent Achieved</th>
        </tr>
        </thead>
        </cfoutput>
        <tbody>
        <cfoutput query="formula">
		
		
		<!-- 2024-1-24 Added new condition to hide certain data - Tim Tran -->
		<cfif (scope NEQ "nata" && scope NEQ "natc") || (find("4", #b_area#) GT 0 )>
		
            <tr>
                <td valign="bottom" nowrap style="text-align: right; padding-right: 3px;">
                    <cfif scope EQ "nata">
                        <a href="#thisTemplate#?scope=area&beginPeriod=#beginPeriod#&endPeriod=#endPeriod#&area=#b_area#&unit=nata" title="Link to Variance Report for #b_area_name#">(#b_area#) #b_area_name#</a>
                    <cfelseif scope EQ "natc">
                        <a href="#thisTemplate#?scope=cluster&beginPeriod=#beginPeriod#&endPeriod=#endPeriod#&cluster=#b_cluster#&unit=natc" title="Link to Variance Report for #b_cluster_name#">(#b_area#) #b_cluster_name#</a>
                    <cfelse>
                        <a href="avar_#thisApp#1.cfm#urlParms#&unit=#b_fin_nbr#" title="Link to #b_fin_name# Unit Variance Report">#b_fin_name#</a>
                        <cfif b_rto_ind EQ 1><span style="font-size: 9px;" title="Unit is an RTI">(RTO)</span></cfif>
                        <cfif b_fss_ind EQ 1 AND b_dps_ind EQ 1><span style="font-size: 9px;" title="Unit has Both City DPS Flats and Letters">(B)</span>
                        <cfelseif b_fss_ind EQ 1 AND b_dps_ind EQ 0><span style="font-size: 9px;" title="Unit has City DPS Flats">(F)</span>
                        <cfelseif b_fss_ind EQ 0 AND b_dps_ind EQ 1><span style="font-size: 9px;" title="Unit has City DPS Letters">(L)</span>
                        <cfelse><span style="font-size: 9px;" title="Unit has no City DPS Flats or Letters">(N)</span>
                        </cfif>
                    </cfif>
                    <!--- <cfif qryRTO.b_rto_ind EQ 1><span style="font-size: 9px;" title="Unit is an RTO Site.">&nbsp;(RTO)</span></cfif> --->
                </td>
                <cfif TotWebCoinsCarriers EQ '' || w_cty_rte EQ '' || w_cty_rte EQ 0>
                    <cfset actualCSR = 0 />
                <cfelse>
                    <cfset actualCSR = TotWebCoinsCarriers/w_cty_rte />
                </cfif>
                <td align="center" width="100">#NumberFormat(act_pct_standard*100, '9')#</td>
                <!---
                <td align="center" width="100">#decimalFormat(oei2sply*100)#</td>
                <td align="center" width="100">#decimalFormat(sei2sply*100)#</td>
                --->
                <td align="center" width="100">#decimalFormat(dph2sply*100)#</td>
                <td align="center" width="100">#NumberFormat(dps_pct*100, '9')#</td>
                <td align="center" width="100">#NumberFormat(fss_pct*100, '9')#</td>
                <td align="center" width="100">#NumberFormat(ManVolPct*100, '9')#</td>
                <td align="center" width="100">#decimalformat(actualCSR)#</td>
                <td align="center" width="100">#decimalFormat(ot_pct*100)#</td>
                <td align="center" width="100">#decimalFormat(dly_fters_opp)#</td>
                <td align="center" width="100">#decimalFormat(dly_ofc_opp)#</td>
                <td align="center" width="100">#decimalFormat(dly_str_opp)#</td>
                <td align="center" width="100">#decimalFormat(dly_oth_opp)#</td>
                <td align="center" width="100">#decimalFormat(dly_tot_opp)#</td>
                <td align="center" width="100">#decimalFormat(tot_pct_ach*100)#</td>
            </tr>
			
		</cfif>	
			
			
			
        </cfoutput>
        </tbody>
    <tr> <!--- MUST BE BELOW THE TBODY CLOSE OR IT WILL BE INCLUDED IN THE SORT RESULTS --->
        <cfoutput>
        <td height="22" bgcolor="##cccccc" valign="bottom" align="center" colspan="14" style="vertical-align: bottom;">
            <a href="avar_select.cfm" title="Return to Variance Selection Page"><img src="/images/avar_return.gif" width="94" height="15" border="0" alt=""></a>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <a href="avar_#thisApp#_exec2xl.cfm#exportParms#" title="Download City Deliver Variance Summary to Excel"><img src="/images/avar_send2excel.gif" width="80" height="15" alt="Download City Delivery Variance Summary to Excel" border="0"></a>
        </td>
        </cfoutput>
    </tr>
</table>
</div>
<cfcatch type="any">
    <cfoutput>#cfcatch.detail#</cfoutput>
</cfcatch>
</cftry>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modernized City Delivery Pivot Opportunity Model</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/2.1.8/css/dataTables.bootstrap5.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4"></script>
    <style>
        body { font-family: 'Verdana', sans-serif; background-color: #f8f9fa; }
        .header-bg { background-color: #003263; color: white; }
        .kpi-row { font-size: 0.875rem; }
        .daily-opp { background-color: #ccccff; }
        .achievement-cell { text-align: center; font-weight: bold; }
        .chart-icon { width: 20px; height: 20px; }
        .export-btn { background-color: #f8f8ff; padding: 10px; text-align: center; }
        /* Color coding for % Achieved (based on your original logic) */
        .ach-low { background-color: #FF6666; } /* <75% */
        .ach-med { background-color: #FFFF66; } /* 75-85% */
        .ach-high { background-color: #66FF66; } /* 85-95% */
        .ach-top { background-color: #6666FF; } /* >=95% */
    </style>
</head>
<body>
    <div class="container my-4">
        <!-- Navigation Header -->
        <div class="row">
            <div class="col-12 header-bg p-2 text-center">
                <a href="#" class="text-white me-3">Return to Range Selection</a> -->
                <a href="#" class="text-white">National Level</a> -->
                <a href="#" class="text-white">Cluster Level</a>
            </div>
        </div>

        <!-- Title -->
        <div class="row mt-3">
            <div class="col-12 header-bg p-3 text-center">
                <h5 class="mb-0">Ma-Ri - MPOO G City Delivery Pivot Opportunity Model 11 Delivery Days 11/22/2025 to 12/05/2025</h5>
            </div>
        </div>

        <!-- KPI Summary Rows -->
        <div class="row mt-3 header-bg text-white kpi-row">
            <div class="col-md-4 p-2">Base number of Equivalent City Routes: 476</div>
            <div class="col-md-4 p-2">Earned Rts Equivalent Workload: 430</div>
            <div class="col-md-4 p-2">Actual Rts Equivalent Workhours: 449</div>
        </div>
        <div class="row header-bg text-white kpi-row">
            <div class="col-md-4 p-2">Daily Pivot Opportunity: 46</div>
            <div class="col-md-4 p-2">Rts Pivot Performance Actual: 27</div>
            <div class="col-md-4 p-2">Pivot Opportunity % Achieved: 59%</div>
        </div>

        <!-- Modern Charts for KPIs -->
        <div class="row mt-4">
            <!-- Bar Chart for Overall KPIs -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">KPI Summary Bar Chart</div>
                    <div class="card-body">
                        <canvas id="kpiBarChart"></canvas>
                    </div>
                </div>
            </div>
            <!-- Doughnut Chart for % Achieved -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Pivot Opportunity % Achieved</div>
                    <div class="card-body">
                        <canvas id="achievementDoughnut"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modernized Table -->
        <div class="row mt-4">
            <div class="col-12">
                <table id="pivotTable" class="table table-striped table-hover table-bordered">
                    <thead class="table-dark">
                        <tr>
                            <th>Chart</th>
                            <th>Fin Nbr</th>
                            <th>Unit Name</th>
                            <th>Base Nbr of Equivalent City Rts</th>
                            <th>Earned Rts Equivalent Workload</th>
                            <th>Actual Rts Equivalent Workhours</th>
                            <th>Daily Pivot Opportunity</th>
                            <th>Rts Pivot Performance Actual</th>
                            <th>Pivot Opportunity % Achieved</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Sample row from your screenshot; repeat for others -->
                        <tr>
                            <td><canvas class="chart-icon" data-chart-data="[1.84, 0.93, 0.50]"></canvas></td> <!-- Mini sparkline -->
                            <td>245168</td>
                            <td>ABINGTON PO</td>
                            <td>14.69</td>
                            <td>12.84</td>
                            <td>13.76</td>
                            <td class="daily-opp">1.84</td>
                            <td>0.93</td>
                            <td class="achievement-cell ach-top">50.30</td>
                        </tr>
                        <!-- Add more rows similarly... -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Export Section -->
        <div class="row mt-3 export-btn">
            <div class="col-12">
                <a href="#" class="btn btn-primary">Send to Excel National Area Level Data</a>
                <a href="#" class="btn btn-primary ms-3">Send to Excel National Unit Level Data</a>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.1.8/js/dataTables.bootstrap5.js"></script>
    <script>
        // Initialize DataTable
        new DataTable('#pivotTable', { order: [[8, 'desc']] }); // Sort by % Achieved descending

        // KPI Bar Chart
        new Chart(document.getElementById('kpiBarChart'), {
            type: 'bar',
            data: {
                labels: ['Base Routes', 'Earned Workload', 'Actual Workhours', 'Daily Opp', 'Perf Actual'],
                datasets: [{ label: 'Values', data: [476, 430, 449, 46, 27], backgroundColor: ['#003263', '#66FF66', '#FF6666', '#ccccff', '#6666FF'] }]
            },
            options: { scales: { y: { beginAtZero: true } } }
        });

        // Achievement Doughnut Chart
        new Chart(document.getElementById('achievementDoughnut'), {
            type: 'doughnut',
            data: {
                labels: ['Achieved', 'Remaining'],
                datasets: [{ data: [59, 41], backgroundColor: ['#66FF66', '#FF6666'] }]
            },
            options: { cutout: '70%', plugins: { legend: { position: 'bottom' } } }
        });

        // Mini Sparklines in Chart Column (one per row)
        document.querySelectorAll('.chart-icon').forEach(canvas => {
            new Chart(canvas, {
                type: 'line',
                data: { labels: ['Day1', 'Day2', 'Day3'], datasets: [{ data: JSON.parse(canvas.dataset.chartData), borderColor: '#003263', fill: false }] },
                options: { plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } } }
            });
        });

        // Dynamic Color Coding for % Achieved (run after table load)
        document.querySelectorAll('.achievement-cell').forEach(cell => {
            const val = parseFloat(cell.textContent);
            if (val < 75) cell.classList.add('ach-low');
            else if (val < 85) cell.classList.add('ach-med');
            else if (val < 95) cell.classList.add('ach-high');
            else cell.classList.add('ach-top');
        });
    </script>
</body>
</html>

















<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Pivot Opportunity ‚Äî Modern Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Tailwind CDN (for quick demo) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- DataTables and Buttons for export -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>

  <style>
    /* small tweak to make KPI numbers stand out */
    .kpi-num { font-size: 1.6rem; font-weight: 700; }
    .kpi-label { font-size: 0.85rem; color: #374151; }
    .pct-cell { color: white; font-weight: 700; padding: 0.25rem 0.5rem; border-radius: 4px; display:inline-block; min-width:64px; text-align:center;}
  </style>
</head>
<body class="bg-slate-50 font-sans">

  <div class="max-w-7xl mx-auto p-4">
    <!-- Header / Bread -->
    <div class="mb-4">
      <a class="text-sky-700 underline" href="avar_pivot.cfm">Return to Range Selection</a>
      <h1 class="text-2xl font-semibold mt-2">City Delivery Pivot Opportunity ‚Äî Modern View</h1>
      <p class="text-sm text-slate-600">Same metrics and queries ‚Äî modern presentation</p>
    </div>

    <!-- KPIs -->
    <div class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
      <!-- KPI cards will be built by JS -->
      <div id="kpis" class="col-span-6 grid grid-cols-2 gap-3"></div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
      <div class="lg:col-span-2 bg-white shadow rounded p-4">
        <canvas id="barTop10" height="160"></canvas>
      </div>
      <div class="bg-white shadow rounded p-4">
        <canvas id="pctDonut" height="160"></canvas>
      </div>
    </div>

    <!-- Data table -->
    <div class="bg-white shadow rounded p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold">Area / Unit Pivot Summary</h2>
        <div>
          <button id="refreshBtn" class="px-3 py-1 bg-sky-600 text-white rounded">Refresh</button>
        </div>
      </div>

      <table id="pivotTable" class="stripe hover w-full" style="width:100%">
        <thead>
          <tr>
            <th>Chart</th>
            <th>Area</th>
            <th>Area Name</th>
            <th>Base Routes</th>
            <th>Earned Workload</th>
            <th>Actual Workhours</th>
            <th>Daily Pivot Opp</th>
            <th>Pivot Perf Actual</th>
            <th>% Achieved</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

    </div>
  </div>

<script>
/*
  Expected REST responses (examples)
  GET /api/pivot/summary  => { base_sum, earned_sum, actual_sum, daily_pivot_sum, pivot_perf_sum, pct_ach_avg }
  GET /api/pivot/list     => [ { areaCode, areaName, baseRoutes, earnedWorkload, actualWorkhours, dailyPivotOpp, pivotPerfActual, pctAchieved } ... ]
  For demo, this script uses a small static example. Replace fetch mocks with real fetch() calls to your new endpoints.
*/

async function fetchSummary() {
  // Replace this with: return fetch('/api/pivot/summary').then(r=>r.json());
  return {
    base_sum: 138753.81,
    earned_sum: 124417.81,
    actual_sum: 133007.89,
    daily_pivot_sum: 14336,
    pivot_perf_sum: 5745.92,
    pct_ach_avg: 0.4008
  };
}

async function fetchList() {
  // Replace this with: return fetch('/api/pivot/list').then(r=>r.json());
  // Minimal demo dataset
  return [
    { areaCode: '4J', areaName: 'CENTRAL RETAIL & DELI', baseRoutes: 34202.01, earnedWorkload:30066.19, actualWorkhours:33004.93, dailyPivotOpp:4135.83, pivotPerfActual:1197.08, pctAchieved:0.2894 },
    { areaCode: '4B', areaName: 'ATLANTIC RETAIL & DEL', baseRoutes:40706.20, earnedWorkload:36362.57, actualWorkhours:38734.22, dailyPivotOpp:4343.63, pivotPerfActual:1971.98, pctAchieved:0.4540 },
    // ... load more rows here
  ];
}

function formatNumber(v) {
  if (v === null || v === undefined) return '-';
  return Intl.NumberFormat().format(Math.round(v*100)/100);
}

function pctColor(p) {
  // p in 0..1
  if (p >= 0.95) return 'bg-sky-700';    // blue for perfect
  if (p >= 0.85) return 'bg-emerald-600'; // green
  if (p >= 0.75) return 'bg-amber-400';   // yellow
  return 'bg-rose-500';                   // red
}

async function renderDashboard() {
  const summary = await fetchSummary();
  const list = await fetchList();

  // Render KPI cards
  const kpiRoot = document.getElementById('kpis');
  kpiRoot.innerHTML = '';
  const kpis = [
    { label: 'Base number of Equivalent City Routes', value: summary.base_sum },
    { label: 'Earned Rts Equivalent Workload', value: summary.earned_sum },
    { label: 'Actual Rts Equivalent Workhours', value: summary.actual_sum },
    { label: 'Daily Pivot Opportunity', value: summary.daily_pivot_sum },
    { label: 'Rts Pivot Performance Actual', value: summary.pivot_perf_sum },
    { label: 'Pivot Opportunity % Achieved', value: (summary.pct_ach_avg*100) }
  ];
  kpis.forEach(k=>{
    const el = document.createElement('div');
    el.className = 'bg-white shadow rounded p-3 flex flex-col';
    el.innerHTML = `<div class="kpi-num">${k.label.includes('%') ? k.value.toFixed(2) + '%' : formatNumber(k.value)}</div>
                    <div class="kpi-label">${k.label}</div>`;
    kpiRoot.appendChild(el);
  });

  // Build datatable rows
  const tbody = document.querySelector('#pivotTable tbody');
  tbody.innerHTML = '';
  list.forEach(r=>{
    const pct = Math.round((r.pctAchieved||0)*10000)/100;
    // conditional class
    const pctClass = pctColor(r.pctAchieved||0);
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><a href="pivot/pivot_main.cfm?area_no=${encodeURIComponent(r.areaCode)}" target="_blank" class="text-sky-600">üîç</a></td>
                    <td>${r.areaCode||''}</td>
                    <td class="text-left">${r.areaName||''}</td>
                    <td class="text-right">${formatNumber(r.baseRoutes)}</td>
                    <td class="text-right">${formatNumber(r.earnedWorkload)}</td>
                    <td class="text-right">${formatNumber(r.actualWorkhours)}</td>
                    <td class="text-right">${formatNumber(r.dailyPivotOpp)}</td>
                    <td class="text-right">${formatNumber(r.pivotPerfActual)}</td>
                    <td class="text-center"><span class="pct-cell ${pctClass}">${pct}%</span></td>`;
    tbody.appendChild(tr);
  });

  // Initialize DataTable (Buttons for Excel export)
  $('#pivotTable').DataTable( {
    destroy: true,
    dom: 'Bfrtip',
    buttons: [
      {
        extend: 'excelHtml5',
        title: 'Pivot_Opportunity_export'
      }
    ],
    pageLength: 25
  });

  // Charts
  // Top 10 daily pivot
  const top10 = list.slice().sort((a,b)=>b.dailyPivotOpp - a.dailyPivotOpp).slice(0,10);
  const ctx = document.getElementById('barTop10').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: top10.map(d=>d.areaCode+' '+d.areaName),
      datasets: [{
        label: 'Daily Pivot Opportunity',
        data: top10.map(d=>d.dailyPivotOpp),
        borderWidth: 1
      }]
    },
    options: {
      plugins: { legend: { display:false } },
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { ticks: { autoSkip: false } },
        y: { beginAtZero:true }
      },
      onClick: (e, items) => {
        if (items.length) {
          const i = items[0].index;
          const area = top10[i];
          // open drill link
          window.open(`avar_pivot2.cfm?viewLevel=C&b_area=${encodeURIComponent(area.areaCode)}`, '_blank');
        }
      }
    }
  });

  // Donut: % achieved overall
  const pctCtx = document.getElementById('pctDonut').getContext('2d');
  new Chart(pctCtx, {
    type: 'doughnut',
    data: {
      labels: ['Captured','Remaining'],
      datasets: [{
        data: [summary.pct_ach_avg*100, (1-summary.pct_ach_avg)*100],
        borderWidth: 1
      }]
    },
    options: {
      plugins: { legend:{ position: 'bottom' } },
      maintainAspectRatio:false,
      cutout: '70%'
    }
  });
}

document.getElementById('refreshBtn').addEventListener('click', renderDashboard);
renderDashboard();

</script>
</body>
</html>
